# Solution Diagrams - Loved CRM

## 1. Architecture Overview

**System Stack**: Next.js 14 + FastAPI + PostgreSQL + Railway  
**Multi-Tenancy**: organization_id isolation across all layers  
**Integration Pattern**: Dual provider architecture para WhatsApp + VoIP  
**Total Diagrams**: 10 comprehensive technical diagrams  

**Template Foundation Verified:**
- âœ… 32 componentes shadcn/ui disponÃ­veis no sistema atual
- âœ… FastAPI com 8 routers principais jÃ¡ implementados
- âœ… Multi-tenant organization middleware jÃ¡ ativo
- âœ… ConfiguraÃ§Ã£o Tailwind com cores CRM customizadas
- âœ… Railway deployment com proxy Next.js configurado

## 2. System Architecture Diagram

### High-Level System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           LOVED CRM - COMPLETE SYSTEM                           â”‚
â”‚                        Multi-Tenant B2B CRM Architecture                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                PRESENTATION LAYER
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Next.js 14 Frontend                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Landing Page  â”‚  â”‚  Admin Dashboard â”‚  â”‚  CRM Interface  â”‚  â”‚ Auth Pages   â”‚ â”‚
â”‚  â”‚   /[locale]/    â”‚  â”‚ /[locale]/admin  â”‚  â”‚ /admin/crm/*    â”‚  â”‚ /auth/*      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          shadcn/ui Components + Tailwind CSS (32 components)               â”‚ â”‚
â”‚  â”‚  â€¢ Pipeline Kanban    â€¢ WhatsApp Chat     â€¢ AI Summary     â€¢ Team Mgmt    â”‚ â”‚
â”‚  â”‚  â€¢ Lead Management    â€¢ VoIP Interface    â€¢ Templates      â€¢ Billing      â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚  X-Org-Id Headers    â”‚
                            â”‚  JWT + Org Context   â”‚
                            â”‚  Railway Proxy       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                APPLICATION LAYER
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FastAPI Backend (Python 3.11+)                       â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        MIDDLEWARE STACK                                    â”‚ â”‚
â”‚  â”‚  SecurityHeaders â†’ OrganizationContext â†’ RateLimit â†’ SentryContext        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                            CORE ROUTERS                                     â”‚ â”‚
â”‚  â”‚  /auth      /organizations   /users        /billing      /crm/leads        â”‚ â”‚
â”‚  â”‚  /invites   /roles          /preferences  /websocket                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                         BUSINESS LAYER                                      â”‚ â”‚
â”‚  â”‚  Services â†’ Repositories â†’ Models (SQLAlchemy 2.0)                        â”‚ â”‚
â”‚  â”‚  â€¢ Multi-tenant isolation    â€¢ AI integration      â€¢ Provider management   â”‚ â”‚
â”‚  â”‚  â€¢ Lead scoring pipeline     â€¢ Real-time messaging â€¢ Background jobs       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                 DATA LAYER
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PostgreSQL 16 Database                               â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                        MULTI-TENANT SCHEMA                                 â”‚ â”‚
â”‚  â”‚                                                                             â”‚ â”‚
â”‚  â”‚  Core: organizations, users, organization_members, subscriptions           â”‚ â”‚
â”‚  â”‚  Business: leads, pipeline_stages, messages, call_logs, templates          â”‚ â”‚
â”‚  â”‚  Providers: whatsapp_configs, voip_configs, marketing_integrations         â”‚ â”‚
â”‚  â”‚  AI/ML: ai_conversations, lead_scoring_models, analytics_events            â”‚ â”‚
â”‚  â”‚  System: api_keys, webhook_subscriptions, background_jobs, audit_logs      â”‚ â”‚
â”‚  â”‚                                                                             â”‚ â”‚
â”‚  â”‚  ğŸ”’ ALL TABLES: organization_id isolation + performance indexes            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚      Redis Cache        â”‚  â”‚    Background Jobs      â”‚                      â”‚
â”‚  â”‚  â€¢ Session storage      â”‚  â”‚  â€¢ Email sending        â”‚                      â”‚
â”‚  â”‚  â€¢ Real-time messaging  â”‚  â”‚  â€¢ AI processing        â”‚                      â”‚
â”‚  â”‚  â€¢ AI context cache     â”‚  â”‚  â€¢ Webhook delivery     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                             INTEGRATION LAYER
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          External Integrations                                 â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   WhatsApp      â”‚  â”‚     VoIP        â”‚  â”‚   AI Services   â”‚  â”‚  Marketing   â”‚ â”‚
â”‚  â”‚ Business API âœ…  â”‚  â”‚  Twilio âœ…       â”‚  â”‚  OpenAI GPT-4   â”‚  â”‚ Facebook Ads â”‚ â”‚
â”‚  â”‚ Web API (alt) âš ï¸ â”‚  â”‚  Telnyx (alt)   â”‚  â”‚  Sentiment AI   â”‚  â”‚ Google Ads   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    Calendar     â”‚  â”‚    Billing      â”‚  â”‚     Email       â”‚  â”‚   Storage    â”‚ â”‚
â”‚  â”‚ Google Calendar â”‚  â”‚    Stripe       â”‚  â”‚   SendGrid      â”‚  â”‚   Railway    â”‚ â”‚
â”‚  â”‚  OAuth2 + Sync  â”‚  â”‚  Connect API    â”‚  â”‚   Templates     â”‚  â”‚   File Store â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Legend:
  âœ… Primary Provider    âš ï¸ Alternative Provider    ğŸ”’ Security Layer
  â†’ Data Flow           â† Response Flow           â• Multi-tenant Isolation
```

### Multi-Tenant Data Flow

```
USER REQUEST                     ORGANIZATION VALIDATION             DATABASE ACCESS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€             â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend    â”‚ â”€â”€ X-Org-Id â”€â”€â”€â†’ â”‚ Organization        â”‚ â”€â”€ org_id â”€â†’â”‚ PostgreSQL  â”‚
â”‚ JWT Token   â”‚    Header        â”‚ Context Middleware  â”‚    Filter   â”‚ Query with  â”‚
â”‚ User Action â”‚                  â”‚                     â”‚             â”‚ org_id = ?  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                                    â”‚                               â”‚
       â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
       â”‚                         â”‚ VALIDATION RULES    â”‚                   â”‚
       â”‚                         â”‚ â€¢ JWT org matches   â”‚                   â”‚
       â”‚                         â”‚ â€¢ Header org valid  â”‚                   â”‚
       â”‚                         â”‚ â€¢ User in org       â”‚                   â”‚
       â”‚                         â”‚ â€¢ Cross-org denied  â”‚                   â”‚
       â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
       â”‚                                    â”‚                               â”‚
       â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
       â””â”€â”€â”€â”€â”€â”€ RESPONSE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ 200: Success       â”‚â†â”€â”€â”€â”€ RESULT â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚ 403: Org mismatch  â”‚
                                 â”‚ 401: No auth       â”‚
                                 â”‚ 422: Invalid data  â”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. Database Schema Diagrams

### Core Multi-Tenant Schema

```
FOUNDATION TABLES (Multi-Tenancy Core)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    organizations    â”‚         â”‚        users        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ id (PK) UUID        â”‚    â”Œâ”€â”€â”€â”€â”‚ id (PK) UUID        â”‚
â”‚ name VARCHAR(255)   â”‚    â”‚    â”‚ email VARCHAR(255)  â”‚
â”‚ slug VARCHAR(100)   â”‚    â”‚    â”‚ password_hash       â”‚
â”‚ plan_tier VARCHAR   â”‚    â”‚    â”‚ full_name           â”‚
â”‚ settings JSONB      â”‚    â”‚    â”‚ is_active BOOLEAN   â”‚
â”‚ features_enabled    â”‚    â”‚    â”‚ email_verified      â”‚
â”‚ created_at          â”‚    â”‚    â”‚ last_login_at       â”‚
â”‚ updated_at          â”‚    â”‚    â”‚ created_at          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚ updated_at          â”‚
           â”‚               â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚ 1:N           â”‚               â”‚
           â”‚               â”‚               â”‚ N:M
           â–¼               â”‚               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             organization_members                        â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ id (PK) UUID                                            â”‚
â”‚ organization_id (FK) â†’ organizations.id                 â”‚
â”‚ user_id (FK) â†’ users.id                                 â”‚
â”‚ role VARCHAR(50) (admin, manager, sales, viewer)        â”‚
â”‚ permissions JSONB                                       â”‚
â”‚ is_active BOOLEAN                                       â”‚
â”‚ joined_at TIMESTAMPTZ                                   â”‚
â”‚ UNIQUE(organization_id, user_id)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Business Logic Schema

```
PIPELINE & LEAD MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 1:N  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 1:N  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  pipeline_stages    â”‚â”€â”€â”€â”€â”€â–¶â”‚       leads         â”‚â”€â”€â”€â”€â”€â–¶â”‚   lead_activities   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ id (PK)             â”‚      â”‚ id (PK)             â”‚      â”‚ id (PK)             â”‚
â”‚ organization_id (FK)â”‚      â”‚ organization_id (FK)â”‚      â”‚ organization_id (FK)â”‚
â”‚ name VARCHAR(100)   â”‚      â”‚ full_name           â”‚      â”‚ lead_id (FK)        â”‚
â”‚ stage_order INTEGER â”‚      â”‚ email               â”‚      â”‚ user_id (FK)        â”‚
â”‚ color VARCHAR(7)    â”‚      â”‚ phone               â”‚      â”‚ activity_type       â”‚
â”‚ is_active BOOLEAN   â”‚      â”‚ company             â”‚      â”‚ title VARCHAR(255)  â”‚
â”‚ stage_type VARCHAR  â”‚      â”‚ stage_id (FK)       â”‚      â”‚ description TEXT    â”‚
â”‚ created_at          â”‚      â”‚ assigned_to (FK)    â”‚      â”‚ metadata JSONB      â”‚
â”‚ updated_at          â”‚      â”‚ source VARCHAR      â”‚      â”‚ duration_minutes    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ lead_score INTEGER  â”‚      â”‚ external_id         â”‚
                             â”‚ probability_%       â”‚      â”‚ external_provider   â”‚
                             â”‚ estimated_value     â”‚      â”‚ created_at          â”‚
                             â”‚ custom_fields JSONB â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ status VARCHAR      â”‚
                             â”‚ converted_at        â”‚
                             â”‚ created_at          â”‚
                             â”‚ updated_at          â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Organization Isolation: ALL tables have organization_id with indexes
Performance Indexes: ix_leads_org_stage, ix_activities_org_lead_created
Constraints: stage_id must belong to same organization as lead
```

### Communication Provider Schema

```
DUAL PROVIDER ARCHITECTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                whatsapp_configs                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ id (PK) UUID                                            â”‚
â”‚ organization_id (FK) â†’ organizations.id                 â”‚
â”‚ provider_type VARCHAR(50) (business_api, web_unofficial)â”‚
â”‚ is_active BOOLEAN                                       â”‚
â”‚                                                         â”‚
â”‚ -- Business API fields                                  â”‚
â”‚ business_phone_id VARCHAR(100)                          â”‚
â”‚ access_token TEXT                                       â”‚
â”‚ webhook_verify_token VARCHAR(255)                       â”‚
â”‚                                                         â”‚
â”‚ -- Web API fields                                       â”‚
â”‚ session_id VARCHAR(100)                                 â”‚
â”‚ qr_code_data TEXT                                       â”‚
â”‚ connection_status VARCHAR(50)                           â”‚
â”‚                                                         â”‚
â”‚ config_data JSONB                                       â”‚
â”‚ UNIQUE: one active config per organization              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼ 1:N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     messages                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ id (PK) UUID                                            â”‚
â”‚ organization_id (FK) â†’ organizations.id                 â”‚
â”‚ lead_id (FK) â†’ leads.id (nullable)                      â”‚
â”‚ conversation_id UUID                                    â”‚
â”‚                                                         â”‚
â”‚ provider_type VARCHAR(50)                               â”‚
â”‚ provider_message_id VARCHAR(255)                        â”‚
â”‚ direction VARCHAR(10) (inbound, outbound)              â”‚
â”‚ message_type VARCHAR(50) (text, image, audio, etc)     â”‚
â”‚ content TEXT                                            â”‚
â”‚                                                         â”‚
â”‚ from_number VARCHAR(50)                                 â”‚
â”‚ to_number VARCHAR(50)                                   â”‚
â”‚ contact_name VARCHAR(255)                               â”‚
â”‚                                                         â”‚
â”‚ status VARCHAR(50) (pending, sent, delivered, read)    â”‚
â”‚ delivered_at TIMESTAMPTZ                                â”‚
â”‚ read_at TIMESTAMPTZ                                     â”‚
â”‚                                                         â”‚
â”‚ -- AI Analysis                                          â”‚
â”‚ sentiment_score FLOAT (-1.0 to 1.0)                    â”‚
â”‚ urgency_score INTEGER (0-100)                          â”‚
â”‚ ai_summary TEXT                                         â”‚
â”‚ ai_processed_at TIMESTAMPTZ                            â”‚
â”‚                                                         â”‚
â”‚ metadata JSONB                                          â”‚
â”‚ created_at TIMESTAMPTZ                                  â”‚
â”‚ updated_at TIMESTAMPTZ                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Similar pattern for VoIP with voip_configs and call_logs tables
```

### AI & Machine Learning Schema

```
AI CONTEXT MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 1:N  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” 1:N  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ lead_scoring_models â”‚â”€â”€â”€â”€â”€â–¶â”‚  ai_conversations   â”‚â”€â”€â”€â”€â”€â–¶â”‚  ai_training_data   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚      â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ id (PK)             â”‚      â”‚ id (PK)             â”‚      â”‚ id (PK)             â”‚
â”‚ organization_id (FK)â”‚      â”‚ organization_id (FK)â”‚      â”‚ organization_id (FK)â”‚
â”‚ model_name          â”‚      â”‚ lead_id (FK)        â”‚      â”‚ created_by (FK)     â”‚
â”‚ model_version       â”‚      â”‚ conversation_title  â”‚      â”‚ data_type VARCHAR   â”‚
â”‚ model_type VARCHAR  â”‚      â”‚ context_summary     â”‚      â”‚ category VARCHAR    â”‚
â”‚ config_data JSONB   â”‚      â”‚ total_messages      â”‚      â”‚ input_text TEXT     â”‚
â”‚ scoring_factors     â”‚      â”‚ status VARCHAR      â”‚      â”‚ expected_output     â”‚
â”‚ accuracy_score      â”‚      â”‚ handed_off_to (FK)  â”‚      â”‚ is_approved BOOLEAN â”‚
â”‚ precision_score     â”‚      â”‚ handed_off_at       â”‚      â”‚ usage_count INTEGER â”‚
â”‚ is_active BOOLEAN   â”‚      â”‚ total_tokens_used   â”‚      â”‚ success_rate FLOAT  â”‚
â”‚ training_completed  â”‚      â”‚ context_tokens      â”‚      â”‚ created_at          â”‚
â”‚ created_at          â”‚      â”‚ qualification_score â”‚      â”‚ updated_at          â”‚
â”‚ updated_at          â”‚      â”‚ success_outcome     â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚ created_at          â”‚
                             â”‚ updated_at          â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Organization-Specific Features:
â€¢ Each org has independent AI models and training data
â€¢ Context summaries isolated by organization_id
â€¢ Token usage tracked per organization for billing
â€¢ One active scoring model per organization constraint
```

## 4. API Architecture Diagrams

### API Endpoint Structure (Template-Compliant)

```
FASTAPI ROUTER ORGANIZATION (No /api/v1 prefix - Template Pattern)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        EXISTING ENDPOINTS                           â”‚
â”‚                     (Template Foundation)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

/auth/*                     /organizations/*               /billing/*
â”œâ”€ POST /register          â”œâ”€ GET /current                â”œâ”€ GET /subscription
â”œâ”€ POST /login             â”œâ”€ PUT /current                â”œâ”€ POST /create-checkout
â”œâ”€ POST /refresh           â”œâ”€ GET /current/members        â”œâ”€ POST /webhook
â”œâ”€ POST /reset-password    â”œâ”€ POST /invite-member         â””â”€ GET /usage
â””â”€ POST /verify-email      â””â”€ DELETE /members/{user_id}

/users/*                   /crm/leads/* (Basic)          /websocket/*
â”œâ”€ GET /me                 â”œâ”€ GET /                      â”œâ”€ WebSocket /ws
â”œâ”€ PUT /me                 â”œâ”€ POST /                     â””â”€ Real-time updates
â”œâ”€ DELETE /me              â”œâ”€ PUT /{lead_id}
â””â”€ GET /preferences        â””â”€ DELETE /{lead_id}

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          NEW ENDPOINTS                              â”‚
â”‚                    (To Be Implemented)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

/crm/pipeline/*                    /integrations/*
â”œâ”€ GET /stages                    â”œâ”€ GET /whatsapp
â”œâ”€ POST /stages                   â”œâ”€ POST /whatsapp/setup
â”œâ”€ PUT /stages/{id}               â”œâ”€ PUT /whatsapp/switch
â”œâ”€ DELETE /stages/{id}            â”œâ”€ POST /whatsapp/qr-code
â””â”€ PATCH /leads/{id}/stage        â”œâ”€ GET /voip
                                  â”œâ”€ POST /voip/setup
/crm/leads/* (Enhanced)           â”œâ”€ PUT /voip/switch
â”œâ”€ GET /activities                â”œâ”€ GET /calendar
â”œâ”€ POST /score                    â”œâ”€ POST /calendar/oauth
â”œâ”€ PUT /assign                    â””â”€ POST /calendar/oauth/callback
â”œâ”€ GET /messages
â”œâ”€ POST /messages                 /ai/*
â””â”€ POST /calls                    â”œâ”€ GET /conversations
                                  â”œâ”€ POST /conversations
/crm/templates/*                  â”œâ”€ POST /conversations/{id}/messages
â”œâ”€ GET /                          â”œâ”€ POST /conversations/{id}/handoff
â”œâ”€ POST /                         â”œâ”€ POST /analyze/sentiment
â”œâ”€ PUT /{id}                      â”œâ”€ GET /leads/{id}/score
â”œâ”€ GET /{id}/stats                â””â”€ PUT /leads/{id}/score
â”œâ”€ POST /{id}/use
â””â”€ GET /suggestions               /analytics/*
                                  â”œâ”€ GET /pipeline
/api-keys/*                       â”œâ”€ GET /leads
â”œâ”€ GET /                          â”œâ”€ GET /communication
â”œâ”€ POST /                         â”œâ”€ GET /team
â”œâ”€ PUT /{id}/scopes               â””â”€ POST /custom-report
â””â”€ DELETE /{id}
```

### Multi-Tenancy API Flow

```
API REQUEST PROCESSING FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚    â”‚   Next.js Proxy  â”‚    â”‚   FastAPI       â”‚
â”‚   X-Org-Id:     â”‚â”€â”€â”€â–¶â”‚   Rewrite Rules  â”‚â”€â”€â”€â–¶â”‚   Organization  â”‚
â”‚   uuid-123      â”‚    â”‚   /api/* â†’       â”‚    â”‚   Middleware    â”‚
â”‚   JWT: Bearer.. â”‚    â”‚   backend:8000/* â”‚    â”‚   Validation    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                                         â–¼
                                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚  VALIDATION     â”‚
                                                â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
                                                â”‚  1. JWT valid?  â”‚
                                                â”‚  2. Org exists? â”‚
                                                â”‚  3. User in org?â”‚
                                                â”‚  4. Headers OK? â”‚
                                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                         â”‚
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â–¼                    â–¼                    â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  âœ… SUCCESS     â”‚  â”‚  âŒ 403 ERROR   â”‚  â”‚  âŒ 401 ERROR   â”‚
                           â”‚  Pass org       â”‚  â”‚  Org mismatch   â”‚  â”‚  No auth/       â”‚
                           â”‚  context to     â”‚  â”‚  User not in    â”‚  â”‚  Invalid token  â”‚
                           â”‚  business layer â”‚  â”‚  organization   â”‚  â”‚                 â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  BUSINESS LAYER â”‚
                           â”‚  Service calls  â”‚
                           â”‚  Repository     â”‚
                           â”‚  with org_id    â”‚
                           â”‚  filtering      â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â”‚  DATABASE       â”‚
                           â”‚  SELECT * FROM  â”‚
                           â”‚  table WHERE    â”‚
                           â”‚  organization_idâ”‚
                           â”‚  = ?            â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Provider Integration Architecture

```
DUAL PROVIDER INTEGRATION PATTERN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

WhatsApp Integration:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           WHATSAPP DUAL PROVIDER                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OPTION 1: Business API (Official)          OPTION 2: Web API (Unofficial)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WhatsApp Business Platform  â”‚           â”‚    whatsapp-web.js Node     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚           â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ â€¢ Meta Official API         â”‚           â”‚ â€¢ QR Code Authentication    â”‚
â”‚ â€¢ Conversation-based billingâ”‚           â”‚ â€¢ Session Management        â”‚
â”‚ â€¢ Requires approval         â”‚           â”‚ â€¢ WebSocket Connection      â”‚
â”‚ â€¢ High reliability          â”‚           â”‚ â€¢ Risk of account ban       â”‚
â”‚ â€¢ Enterprise features       â”‚           â”‚ â€¢ Free to use              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                                         â”‚
               â–¼                                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UNIFIED WHATSAPP SERVICE                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                     â”‚
â”‚ class WhatsAppService:                                              â”‚
â”‚   async def send_message(self, org_id, provider_type, **kwargs):    â”‚
â”‚     if provider_type == BUSINESS_API:                               â”‚
â”‚       return await self.business_api.send_message(org_id, **kwargs) â”‚
â”‚     elif provider_type == WEB_UNOFFICIAL:                           â”‚
â”‚       return await self.web_service.send_message(org_id, **kwargs)  â”‚
â”‚                                                                     â”‚
â”‚ Organization Config:                                                â”‚
â”‚   organization_id: UUID                                             â”‚
â”‚   provider_type: WhatsAppProvider                                   â”‚
â”‚   business_api_config: Optional[BusinessAPIConfig]                  â”‚
â”‚   web_session_config: Optional[WebSessionConfig]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UNIFIED MESSAGE STORAGE                          â”‚
â”‚ provider_type: 'whatsapp_business' or 'whatsapp_web'               â”‚
â”‚ All messages stored with same schema regardless of provider        â”‚
â”‚ Hot-swap capability preserves message history                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Similar pattern for VoIP (Twilio vs Telnyx)
```

## 5. User Journey Flow Diagrams

### Pipeline Management Journey

```
PIPELINE KANBAN VISUAL MANAGEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User Story: "Como gestor comercial quero arrastar leads entre estÃ¡gios customizÃ¡veis"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DRAG & DROP PIPELINE                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[USER ACTION]          [FRONTEND]              [BACKEND]              [DATABASE]
     â”‚                      â”‚                      â”‚                      â”‚
     â”œâ”€ Load Pipeline â”€â”€â”€â”€â–¶ â”‚                      â”‚                      â”‚
     â”‚                      â”œâ”€ GET /crm/pipeline/ â–¶â”‚                      â”‚
     â”‚                      â”‚   stages             â”‚                      â”‚
     â”‚                      â”‚                      â”œâ”€ Query stages WHERE â–¶â”‚
     â”‚                      â”‚                      â”‚   organization_id=?  â”‚
     â”‚                      â”‚ â—€â”€â”€â”€â”€ stages[] â”€â”€â”€â”€â”€â”€â”‚ â—€â”€â”€â”€ results â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚                      â”‚                      â”‚                      â”‚
     â”œâ”€ Drag Lead Card â”€â”€â”€â–¶ â”‚ @dnd-kit/core        â”‚                      â”‚
     â”‚   (Stage: Lead â†’     â”‚ onDragEnd()          â”‚                      â”‚
     â”‚    Contact)          â”‚                      â”‚                      â”‚
     â”‚                      â”‚                      â”‚                      â”‚
     â”œâ”€ Drop Validation â”€â”€â–¶ â”‚ Optimistic Update    â”‚                      â”‚
     â”‚                      â”‚ UI shows movement    â”‚                      â”‚
     â”‚                      â”‚                      â”‚                      â”‚
     â”‚                      â”œâ”€ PATCH /crm/leads/  â–¶â”‚                      â”‚
     â”‚                      â”‚   {id}/stage         â”‚                      â”‚
     â”‚                      â”‚ {new_stage_id: uuid} â”‚                      â”‚
     â”‚                      â”‚                      â”‚                      â”‚
     â”‚                      â”‚                      â”œâ”€ Validate lead &    â–¶â”‚
     â”‚                      â”‚                      â”‚   stage belong to    â”‚
     â”‚                      â”‚                      â”‚   same org_id        â”‚
     â”‚                      â”‚                      â”‚                      â”‚
     â”‚                      â”‚                      â”œâ”€ UPDATE leads SET   â–¶â”‚
     â”‚                      â”‚                      â”‚   stage_id=? WHERE   â”‚
     â”‚                      â”‚                      â”‚   id=? AND org_id=?  â”‚
     â”‚                      â”‚                      â”‚                      â”‚
     â”‚                      â”‚                      â”œâ”€ INSERT activity    â–¶â”‚
     â”‚                      â”‚                      â”‚   (stage_change)     â”‚
     â”‚                      â”‚                      â”‚                      â”‚
     â”‚                      â”‚ â—€â”€â”€â”€ success â”€â”€â”€â”€â”€â”€â”€â”€â”‚ â—€â”€â”€â”€ committed â”€â”€â”€â”€â”€â”€â”‚
     â”‚                      â”‚                      â”‚                      â”‚
     â”‚                      â”œâ”€ WebSocket Broadcastâ”‚                      â”‚
     â”‚                      â”‚   to org members     â”‚                      â”‚
     â”‚                      â”‚                      â”‚                      â”‚
     â”‚ â—€â”€ Real-time Update â”€â”‚ Other users see      â”‚                      â”‚
     â”‚   (Other users)      â”‚ lead movement        â”‚                      â”‚

Edge Cases Handled:
â€¢ Concurrent movement: Optimistic locking + conflict resolution
â€¢ Network failure: Rollback + retry mechanism  
â€¢ Cross-org attempt: 403 Forbidden + audit log
â€¢ Invalid stage: Validation + user feedback
```

### WhatsApp Communication Journey

```
WHATSAPP CONVERSATION WORKFLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User Story: "Como vendedor quero conversar com leads diretamente no CRM"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        WHATSAPP CHAT INTEGRATION                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SETUP PHASE:
[ADMIN]               [FRONTEND]              [BACKEND]              [DATABASE]
    â”‚                      â”‚                      â”‚                      â”‚
    â”œâ”€ Choose Provider â”€â”€â–¶ â”‚ Provider Selection   â”‚                      â”‚
    â”‚   (Business API)     â”‚ Interface            â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”œâ”€ POST /integrations/â–¶â”‚                      â”‚
    â”‚                      â”‚   whatsapp/setup     â”‚                      â”‚
    â”‚                      â”‚ {provider_type:      â”‚                      â”‚
    â”‚                      â”‚  business_api,       â”‚                      â”‚
    â”‚                      â”‚  phone_id: "123",    â”‚                      â”‚
    â”‚                      â”‚  access_token: "..."} â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”‚                      â”œâ”€ Validate & Test    â”‚
    â”‚                      â”‚                      â”‚   WhatsApp API       â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”‚                      â”œâ”€ INSERT whatsapp_   â–¶â”‚
    â”‚                      â”‚                      â”‚   configs WHERE      â”‚
    â”‚                      â”‚                      â”‚   organization_id=?  â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”‚ â—€â”€â”€â”€ setup_status â”€â”€â”‚ â—€â”€â”€â”€ config_saved â”€â”€â”€â”‚

MESSAGING PHASE:
[LEAD]                [WHATSAPP]              [WEBHOOK]              [CRM SYSTEM]
    â”‚                      â”‚                      â”‚                      â”‚
    â”œâ”€ Send Message â”€â”€â”€â”€â”€â–¶ â”‚ WhatsApp Business    â”‚                      â”‚
    â”‚   "Hi, interested    â”‚ Receives message     â”‚                      â”‚
    â”‚    in your service"  â”‚                      â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”œâ”€ Webhook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚ POST /webhooks/     â”‚
    â”‚                      â”‚ {                    â”‚   whatsapp/{org_id} â”‚
    â”‚                      â”‚   message_id: "...", â”‚                     â”‚
    â”‚                      â”‚   from: "+5511...",  â”‚                     â”‚
    â”‚                      â”‚   content: "Hi..."   â”‚                     â”‚
    â”‚                      â”‚ }                    â”‚                     â”‚
    â”‚                      â”‚                      â”‚                     â”‚
    â”‚                      â”‚                      â”œâ”€ Validate Signatureâ–¶â”‚
    â”‚                      â”‚                      â”‚   & Organization     â”‚
    â”‚                      â”‚                      â”‚                     â”‚
    â”‚                      â”‚                      â”œâ”€ Process Message   â–¶â”‚
    â”‚                      â”‚                      â”‚   â€¢ Lead matching   â”‚
    â”‚                      â”‚                      â”‚   â€¢ Store message   â”‚
    â”‚                      â”‚                      â”‚   â€¢ AI analysis     â”‚
    â”‚                      â”‚                      â”‚                     â”‚
    â”‚                      â”‚                      â”‚ â—€â”€â”€â”€ processed â”€â”€â”€â”€â”€â”‚
    â”‚                      â”‚                      â”‚                     â”‚
    â”‚                      â”‚                      â”œâ”€ WebSocket         â–¶â”‚
    â”‚                      â”‚                      â”‚   Broadcast to       â”‚
    â”‚                      â”‚                      â”‚   Assigned Rep       â”‚

[SALES REP]           [FRONTEND]              [BACKEND]              [WHATSAPP]
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚ â—€â”€ Notification â”€â”€â”€â”€â”€â”‚ Real-time message    â”‚                      â”‚
    â”‚   (New message)      â”‚ appears in CRM       â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”œâ”€ Reply in CRM â”€â”€â”€â”€â”€â–¶ â”‚ Chat Interface       â”‚                      â”‚
    â”‚   "Thanks for your   â”‚ (WhatsApp-like UI)   â”‚                      â”‚
    â”‚    interest!"        â”‚                      â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”œâ”€ POST /crm/leads/   â–¶â”‚                      â”‚
    â”‚                      â”‚   {id}/messages      â”‚                      â”‚
    â”‚                      â”‚ {                    â”‚                      â”‚
    â”‚                      â”‚   content: "Thanks", â”‚                      â”‚
    â”‚                      â”‚   provider: "whatsapp"â”‚                     â”‚
    â”‚                      â”‚ }                    â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”‚                      â”œâ”€ Send via WhatsApp â–¶â”‚
    â”‚                      â”‚                      â”‚   Business API       â”‚
    â”‚                      â”‚ â—€â”€â”€â”€ message_sent â”€â”€â”€â”‚ â—€â”€â”€â”€ delivered â”€â”€â”€â”€â”€â”€â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚ â—€â”€ Confirmation â”€â”€â”€â”€â”€â”‚ Message delivered    â”‚                      â”‚
    â”‚   (Delivered)        â”‚ status updated       â”‚                      â”‚
```

### AI-Powered Lead Qualification Journey

```
AI CONVERSATION & LEAD SCORING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

User Story: "Como agÃªncia quero chatbot que qualifica leads automaticamente"

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AI QUALIFICATION FLOW                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[LEAD]                [AI SYSTEM]             [HUMAN HANDOFF]         [LEARNING]
    â”‚                      â”‚                      â”‚                      â”‚
    â”œâ”€ Initial Contact â”€â”€â–¶ â”‚ AI Conversation      â”‚                      â”‚
    â”‚   "Hi, need website" â”‚ Detected             â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”œâ”€ Context Analysis   â–¶â”‚                      â”‚
    â”‚                      â”‚ â€¢ Industry detection â”‚                      â”‚
    â”‚                      â”‚ â€¢ Intent classificationâ”‚                     â”‚
    â”‚                      â”‚ â€¢ Urgency assessment â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”œâ”€ OpenAI GPT-4      â–¶â”‚                      â”‚
    â”‚                      â”‚ "I'd be happy to    â”‚                      â”‚
    â”‚                      â”‚  help! What type    â”‚                      â”‚
    â”‚                      â”‚  of website?"       â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚ â—€â”€ AI Response â”€â”€â”€â”€â”€â”€â”‚ < 2 seconds         â”‚                      â”‚
    â”‚   (Contextual)       â”‚                      â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”œâ”€ Lead Responds â”€â”€â”€â”€â–¶ â”‚ "E-commerce for     â”‚                      â”‚
    â”‚   "E-commerce for    â”‚  clothing brand"    â”‚                      â”‚
    â”‚    clothing brand"   â”‚                      â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”œâ”€ Qualification Q's  â–¶â”‚                      â”‚
    â”‚                      â”‚ â€¢ Budget range?     â”‚                      â”‚
    â”‚                      â”‚ â€¢ Timeline?         â”‚                      â”‚
    â”‚                      â”‚ â€¢ Decision maker?   â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”œâ”€ Real-time Scoring â–¶â”‚                      â”‚
    â”‚                      â”‚ Budget: High (8/10) â”‚                      â”‚
    â”‚                      â”‚ Urgency: Med (6/10) â”‚                      â”‚
    â”‚                      â”‚ Fit: High (9/10)    â”‚                      â”‚
    â”‚                      â”‚ TOTAL SCORE: 85/100 â”‚                      â”‚
    â”‚                      â”‚                      â”‚                      â”‚
    â”‚                      â”œâ”€ Handoff Decision  â–¶â”‚                      â”‚
    â”‚                      â”‚ Score â‰¥ 80 â†’ Human â”‚                      â”‚
    â”‚                      â”‚                     â”‚                      â”‚
    â”‚                      â”œâ”€ Context Transfer â”€â–¶ â”‚ Human Rep Notified   â”‚
    â”‚                      â”‚ Full conversation   â”‚ "High-value lead     â”‚
    â”‚                      â”‚ history + score     â”‚  ready for handoff"  â”‚
    â”‚                      â”‚ breakdown           â”‚                      â”‚
    â”‚                      â”‚                     â”‚                      â”‚
    â”‚                      â”‚                     â”œâ”€ Seamless Takeover â–¶â”‚
    â”‚                      â”‚                     â”‚ "Hi! I'm John from   â”‚
    â”‚                      â”‚                     â”‚  our sales team..."  â”‚
    â”‚                      â”‚                     â”‚                      â”‚
    â”‚                      â”‚                     â”‚                      â”œâ”€ Outcome Tracking â–¶
    â”‚                      â”‚                     â”‚                      â”‚ â€¢ Conversation won?  â”‚
    â”‚                      â”‚                     â”‚                      â”‚ â€¢ Handoff smooth?    â”‚
    â”‚                      â”‚                     â”‚                      â”‚ â€¢ Score accurate?    â”‚
    â”‚                      â”‚                     â”‚                      â”‚                      â”‚
    â”‚                      â”‚ â—€â”€â”€â”€ Feedback Loop â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ Model Improvement  â”‚
    â”‚                      â”‚ Update AI model     â”‚                      â”‚ â€¢ Scoring accuracy   â”‚
    â”‚                      â”‚ based on outcomes   â”‚                      â”‚ â€¢ Question effectivenessâ”‚
    â”‚                      â”‚                     â”‚                      â”‚ â€¢ Handoff timing     â”‚

Edge Cases:
â€¢ Low score (< 50): Continue AI nurturing + educational content
â€¢ Complex query: Immediate human handoff with context
â€¢ Repeat visitor: Load previous context + personalization
â€¢ After hours: AI handles + schedules human follow-up
```

## 6. Integration Architecture

### External Service Integration Pattern

```
THIRD-PARTY INTEGRATIONS ARCHITECTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        INTEGRATION MANAGEMENT                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

CALENDAR INTEGRATION (Google Calendar)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OAuth2 Setup     â”‚â”€â”€â”€â–¶â”‚   Token Management  â”‚â”€â”€â”€â–¶â”‚   Bi-Directional   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚      Sync           â”‚
â”‚ â€¢ Authorization URL â”‚    â”‚ â€¢ Access Token      â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ â€¢ Consent Flow      â”‚    â”‚ â€¢ Refresh Token     â”‚    â”‚ â€¢ CRM â†’ Calendar    â”‚
â”‚ â€¢ State Validation  â”‚    â”‚ â€¢ Auto-refresh      â”‚    â”‚ â€¢ Calendar â†’ CRM    â”‚
â”‚ â€¢ Org Context       â”‚    â”‚ â€¢ Secure Storage    â”‚    â”‚ â€¢ Conflict Resolutionâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚                          â”‚
         â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        CALENDAR EVENTS SYNC                                    â”‚
â”‚                                                                                 â”‚
â”‚ CRM Meeting Creation:                    Calendar Event Change:                â”‚
â”‚ 1. User schedules in CRM               1. User changes in Google Calendar      â”‚
â”‚ 2. POST /calendar/events               2. Google sends webhook                 â”‚
â”‚ 3. API creates Google event            3. POST /webhooks/calendar/{org_id}     â”‚
â”‚ 4. Event ID stored in CRM              4. CRM updates lead timeline            â”‚
â”‚ 5. Lead timeline updated               5. Conflict resolution if needed        â”‚
â”‚                                                                                 â”‚
â”‚ Organization Isolation:                                                         â”‚
â”‚ â€¢ Each org has separate calendar tokens                                         â”‚
â”‚ â€¢ Events filtered by organization_id                                            â”‚
â”‚ â€¢ Cross-org access prevented                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MARKETING PLATFORMS INTEGRATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Facebook Ads      â”‚    â”‚   Google Ads        â”‚    â”‚    ROI Tracking     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ â€¢ Access Token      â”‚    â”‚ â€¢ OAuth2 + Refresh â”‚    â”‚ â€¢ Lead Attribution  â”‚
â”‚ â€¢ Ad Account ID     â”‚    â”‚ â€¢ Customer ID       â”‚    â”‚ â€¢ Conversion Events â”‚
â”‚ â€¢ Campaign Import   â”‚    â”‚ â€¢ Campaign Sync     â”‚    â”‚ â€¢ Revenue Mapping   â”‚
â”‚ â€¢ Lead Events       â”‚    â”‚ â€¢ Keyword Tracking  â”‚    â”‚ â€¢ Performance Calc  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚                          â”‚
         â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MARKETING ROI CALCULATION                              â”‚
â”‚                                                                                 â”‚
â”‚ Lead Generation â†’ CRM Processing â†’ Revenue Attribution                         â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚ 1. Facebook/Google sends lead data                                             â”‚
â”‚ 2. CRM creates lead with source attribution                                    â”‚
â”‚ 3. Sales process tracked through pipeline                                      â”‚
â”‚ 4. Won deals attributed back to marketing campaign                             â”‚
â”‚ 5. ROI calculated: (Revenue - Ad Spend) / Ad Spend                            â”‚
â”‚ 6. Performance dashboard updated per organization                               â”‚
â”‚                                                                                 â”‚
â”‚ Multi-Tenant Considerations:                                                   â”‚
â”‚ â€¢ Each org has independent ad accounts                                          â”‚
â”‚ â€¢ ROI calculations isolated by organization_id                                  â”‚
â”‚ â€¢ Marketing spend tracked per org for accurate ROI                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AI Service Integration

```
AI & MACHINE LEARNING INTEGRATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AI SERVICES STACK                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

OPENAI GPT-4 INTEGRATION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Context Management â”‚â”€â”€â”€â–¶â”‚   Token Optimizationâ”‚â”€â”€â”€â–¶â”‚  Organization       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚  Learning           â”‚
â”‚ â€¢ Conversation      â”‚    â”‚ â€¢ Context Summary   â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚   History Storage   â”‚    â”‚ â€¢ Token Limits      â”‚    â”‚ â€¢ Custom Prompts    â”‚
â”‚ â€¢ Lead Context      â”‚    â”‚ â€¢ Cost Tracking     â”‚    â”‚ â€¢ Training Data     â”‚
â”‚ â€¢ Industry Data     â”‚    â”‚ â€¢ Response Caching  â”‚    â”‚ â€¢ Feedback Loops    â”‚
â”‚ â€¢ Previous Outcomes â”‚    â”‚ â€¢ Batch Processing  â”‚    â”‚ â€¢ Model Refinement  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚                          â”‚
         â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        AI PROCESSING PIPELINE                                  â”‚
â”‚                                                                                 â”‚
â”‚ Message Received â†’ Context Analysis â†’ AI Response â†’ Learning Update            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚ 1. Message arrives from WhatsApp/Email                                         â”‚
â”‚ 2. Load organization-specific context                                          â”‚
â”‚    â€¢ Previous conversations                                                     â”‚
â”‚    â€¢ Lead information                                                           â”‚
â”‚    â€¢ Industry templates                                                         â”‚
â”‚    â€¢ Custom training data                                                       â”‚
â”‚                                                                                 â”‚
â”‚ 3. OpenAI API call with context                                                â”‚
â”‚    â€¢ GPT-4 with organization prompt                                            â”‚
â”‚    â€¢ Token optimization (summarize old context)                                â”‚
â”‚    â€¢ Function calling for CRM actions                                          â”‚
â”‚                                                                                 â”‚
â”‚ 4. Response processing                                                          â”‚
â”‚    â€¢ Generate reply                                                             â”‚
â”‚    â€¢ Update lead scoring                                                        â”‚
â”‚    â€¢ Trigger automations                                                       â”‚
â”‚    â€¢ Log interaction                                                            â”‚
â”‚                                                                                 â”‚
â”‚ 5. Learning feedback                                                            â”‚
â”‚    â€¢ Track response effectiveness                                               â”‚
â”‚    â€¢ Update organization AI model                                              â”‚
â”‚    â€¢ Improve future responses                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SENTIMENT ANALYSIS & SCORING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Real-time         â”‚    â”‚   Urgency          â”‚    â”‚   Action            â”‚
â”‚   Sentiment         â”‚    â”‚   Detection        â”‚    â”‚   Triggers          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ â€¢ Message Analysis  â”‚    â”‚ â€¢ Keywords         â”‚    â”‚ â€¢ High Urgency =    â”‚
â”‚ â€¢ Score (-1 to +1)  â”‚    â”‚ â€¢ Context Clues    â”‚    â”‚   Immediate Alert   â”‚
â”‚ â€¢ Confidence Level  â”‚    â”‚ â€¢ Timing Patterns  â”‚    â”‚ â€¢ Negative Sentimentâ”‚
â”‚ â€¢ Historical Trend  â”‚    â”‚ â€¢ Urgency Score    â”‚    â”‚   = Manager Notify  â”‚
â”‚ â€¢ Baseline Comparisonâ”‚   â”‚   (0-100)          â”‚    â”‚ â€¢ Opportunity =     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   Auto-assign       â”‚
                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7. Component Interaction Diagrams

### Frontend Component Architecture

```
NEXT.JS 14 COMPONENT HIERARCHY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          APP ROUTER STRUCTURE                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

app/
â”œâ”€â”€ [locale]/
â”‚   â”œâ”€â”€ admin/                    â† Organization-scoped admin area
â”‚   â”‚   â”œâ”€â”€ crm/                  â† CRM feature modules
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          â†’ CRM Dashboard Container
â”‚   â”‚   â”‚   â”œâ”€â”€ leads/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx      â†’ Leads List Container  
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ [id]/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ page.tsx  â†’ Lead Detail Container
â”‚   â”‚   â”‚   â”œâ”€â”€ pipeline/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      â†’ Pipeline Kanban Container
â”‚   â”‚   â”‚   â””â”€â”€ settings/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx      â†’ CRM Settings Container
â”‚   â”‚   â”œâ”€â”€ settings/             â† Organization settings
â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx          â†’ Org Settings Container
â”‚   â”‚   â”‚   â”œâ”€â”€ team/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ page.tsx      â†’ Team Management Container  
â”‚   â”‚   â”‚   â””â”€â”€ integrations/
â”‚   â”‚   â”‚       â””â”€â”€ page.tsx      â†’ Integrations Container
â”‚   â”‚   â””â”€â”€ billing/              â† Billing & subscriptions
â”‚   â”‚       â””â”€â”€ page.tsx          â†’ Billing Container
â”‚   â””â”€â”€ auth/                     â† Authentication pages
â”‚       â”œâ”€â”€ login/page.tsx        â†’ Login Container
â”‚       â””â”€â”€ register/page.tsx     â†’ Register Container

COMPONENT INTERACTION FLOW:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CONTAINER-COMPONENT PATTERN                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Page Container    â”‚â”€â”€â”€â–¶â”‚   Business Logic    â”‚â”€â”€â”€â–¶â”‚   API Services      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  
â”‚ â€¢ useOrgContext()   â”‚    â”‚ â€¢ useCRMStore()     â”‚    â”‚ â€¢ leadService.get() â”‚
â”‚ â€¢ Data fetching     â”‚    â”‚ â€¢ useLeadData()     â”‚    â”‚ â€¢ X-Org-Id headers  â”‚
â”‚ â€¢ State management  â”‚    â”‚ â€¢ Business rules    â”‚    â”‚ â€¢ Error handling    â”‚
â”‚ â€¢ Error boundaries  â”‚    â”‚ â€¢ Form validation   â”‚    â”‚ â€¢ Response caching  â”‚
â”‚ â€¢ Loading states    â”‚    â”‚ â€¢ Optimistic updatesâ”‚    â”‚ â€¢ Retry logic       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚                          â”‚
         â–¼                          â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            UI COMPONENTS                                        â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Pipeline Kanban â”‚  â”‚  WhatsApp Chat  â”‚  â”‚   Lead Cards    â”‚  â”‚ AI Summary   â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚ â”‚ â€¢ @dnd-kit/core â”‚  â”‚ â€¢ Message list  â”‚  â”‚ â€¢ Lead info     â”‚  â”‚ â€¢ Collapsibleâ”‚ â”‚
â”‚ â”‚ â€¢ Drag handlers â”‚  â”‚ â€¢ Send input    â”‚  â”‚ â€¢ Score display â”‚  â”‚ â€¢ AI insightsâ”‚ â”‚
â”‚ â”‚ â€¢ Stage columns â”‚  â”‚ â€¢ Attachments   â”‚  â”‚ â€¢ Action buttonsâ”‚  â”‚ â€¢ Suggestionsâ”‚ â”‚
â”‚ â”‚ â€¢ Real-time     â”‚  â”‚ â€¢ Status icons  â”‚  â”‚ â€¢ Pipeline move â”‚  â”‚ â€¢ Export     â”‚ â”‚
â”‚ â”‚   updates       â”‚  â”‚ â€¢ Timestamps    â”‚  â”‚ â€¢ Timeline      â”‚  â”‚   options    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚   Templates     â”‚  â”‚   Team Mgmt     â”‚  â”‚   Analytics     â”‚  â”‚  Settings    â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚ â”‚ â€¢ Template list â”‚  â”‚ â€¢ Member list   â”‚  â”‚ â€¢ Charts/graphs â”‚  â”‚ â€¢ Preferencesâ”‚ â”‚
â”‚ â”‚ â€¢ Variable subs â”‚  â”‚ â€¢ Role mgmt     â”‚  â”‚ â€¢ Export reportsâ”‚  â”‚ â€¢ Integrationsâ”‚ â”‚
â”‚ â”‚ â€¢ A/B testing   â”‚  â”‚ â€¢ Permissions   â”‚  â”‚ â€¢ Date filters  â”‚  â”‚ â€¢ Billing    â”‚ â”‚
â”‚ â”‚ â€¢ Performance   â”‚  â”‚ â€¢ Invitations   â”‚  â”‚ â€¢ KPI tracking  â”‚  â”‚ â€¢ Security   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STATE MANAGEMENT ARCHITECTURE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ZUSTAND STORES                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     CRM Store       â”‚    â”‚     UI Store        â”‚    â”‚    Auth Store       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ â€¢ leads: Lead[]     â”‚    â”‚ â€¢ sidebarOpen       â”‚    â”‚ â€¢ user: User        â”‚
â”‚ â€¢ selectedLead      â”‚    â”‚ â€¢ activeModal       â”‚    â”‚ â€¢ organization      â”‚
â”‚ â€¢ pipelineFilters   â”‚    â”‚ â€¢ loading states    â”‚    â”‚ â€¢ permissions       â”‚
â”‚ â€¢ pipelineStages    â”‚    â”‚ â€¢ error messages    â”‚    â”‚ â€¢ isAuthenticated   â”‚
â”‚ â€¢ templates         â”‚    â”‚ â€¢ notifications     â”‚    â”‚ â€¢ tokens            â”‚
â”‚ â€¢ aiSummaries       â”‚    â”‚ â€¢ theme settings    â”‚    â”‚ â€¢ refreshToken()    â”‚
â”‚ â€¢ updateLead()      â”‚    â”‚ â€¢ toggleSidebar()   â”‚    â”‚ â€¢ logout()          â”‚
â”‚ â€¢ moveToPipeline()  â”‚    â”‚ â€¢ showNotification()â”‚    â”‚ â€¢ switchOrg()       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Real-time Updates via TanStack Query + WebSocket:
â€¢ Pipeline changes broadcast to all org members
â€¢ New messages appear instantly in conversations  
â€¢ AI summaries update in real-time
â€¢ Lead score changes reflect immediately
```

### Backend Service Dependencies

```
FASTAPI SERVICE ARCHITECTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          CLEAN ARCHITECTURE LAYERS                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PRESENTATION LAYER (FastAPI Routers)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚  /auth/*          /crm/*          /integrations/*      /analytics/*            â”‚
â”‚  â”œâ”€ login         â”œâ”€ leads        â”œâ”€ whatsapp          â”œâ”€ pipeline             â”‚
â”‚  â”œâ”€ register      â”œâ”€ pipeline     â”œâ”€ voip              â”œâ”€ team                 â”‚
â”‚  â”œâ”€ refresh       â”œâ”€ templates    â”œâ”€ calendar          â”œâ”€ marketing           â”‚
â”‚  â””â”€ verify        â””â”€ ai           â””â”€ marketing         â””â”€ custom              â”‚
â”‚                                                                                 â”‚
â”‚  Common Dependencies per Route:                                                â”‚
â”‚  â€¢ get_current_organization (Multi-tenancy)                                    â”‚
â”‚  â€¢ get_current_active_user (Authentication)                                    â”‚
â”‚  â€¢ get_db (Database session)                                                   â”‚
â”‚  â€¢ rate_limiter (Rate limiting)                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
BUSINESS LOGIC LAYER (Services)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   CRM Service   â”‚  â”‚  WhatsApp       â”‚  â”‚   AI Service    â”‚  â”‚ Analytics    â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚  Service        â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ Service      â”‚ â”‚
â”‚  â”‚ â€¢ create_lead() â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â€¢ analyze_msg() â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚ â€¢ update_score()â”‚  â”‚ â€¢ send_message()â”‚  â”‚ â€¢ score_lead()  â”‚  â”‚ â€¢ pipeline() â”‚ â”‚
â”‚  â”‚ â€¢ move_stage()  â”‚  â”‚ â€¢ get_history() â”‚  â”‚ â€¢ suggest_reply()â”‚ â”‚ â€¢ team_perf()â”‚ â”‚
â”‚  â”‚ â€¢ assign_lead() â”‚  â”‚ â€¢ switch_providerâ”‚ â”‚ â€¢ handoff_human()â”‚ â”‚ â€¢ roi_calc() â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚ â€¢ validate_msg()â”‚  â”‚                 â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ Dependencies:   â”‚  â”‚                 â”‚  â”‚ Dependencies:   â”‚  â”‚ Dependencies:â”‚ â”‚
â”‚  â”‚ â€¢ LeadsRepo     â”‚  â”‚ Dependencies:   â”‚  â”‚ â€¢ OpenAI API    â”‚  â”‚ â€¢ EventsRepo â”‚ â”‚
â”‚  â”‚ â€¢ ActivitiesRepoâ”‚  â”‚ â€¢ WhatsAppRepo  â”‚  â”‚ â€¢ ConversRepo   â”‚  â”‚ â€¢ LeadsRepo  â”‚ â”‚
â”‚  â”‚ â€¢ PipelineRepo  â”‚  â”‚ â€¢ MessageRepo   â”‚  â”‚ â€¢ TrainingRepo  â”‚  â”‚ â€¢ RevenueDataâ”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ ProviderAPI   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
DATA ACCESS LAYER (Repositories)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Leads Repo    â”‚  â”‚  Messages Repo  â”‚  â”‚   Pipeline Repo â”‚  â”‚ Analytics    â”‚ â”‚
â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚  â”‚ Repo         â”‚ â”‚
â”‚  â”‚ Base: SQLRepo   â”‚  â”‚ Base: SQLRepo   â”‚  â”‚ Base: SQLRepo   â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚ Base: SQLRepoâ”‚ â”‚
â”‚  â”‚ Methods:        â”‚  â”‚ Methods:        â”‚  â”‚ Methods:        â”‚  â”‚              â”‚ â”‚
â”‚  â”‚ â€¢ get_by_org()  â”‚  â”‚ â€¢ get_by_org()  â”‚  â”‚ â€¢ get_by_org()  â”‚  â”‚ Methods:     â”‚ â”‚
â”‚  â”‚ â€¢ create_for_   â”‚  â”‚ â€¢ create_for_   â”‚  â”‚ â€¢ create_for_   â”‚  â”‚ â€¢ events_by_ â”‚ â”‚
â”‚  â”‚   _org()        â”‚  â”‚   _org()        â”‚  â”‚   _org()        â”‚  â”‚   _org()     â”‚ â”‚
â”‚  â”‚ â€¢ update_org_   â”‚  â”‚ â€¢ get_by_lead() â”‚  â”‚ â€¢ update_order()â”‚  â”‚ â€¢ metrics_   â”‚ â”‚
â”‚  â”‚   _scoped()     â”‚  â”‚ â€¢ get_conv()    â”‚  â”‚ â€¢ delete_stage()â”‚  â”‚   _by_org()  â”‚ â”‚
â”‚  â”‚ â€¢ delete_org_   â”‚  â”‚ â€¢ store_ai()    â”‚  â”‚                 â”‚  â”‚ â€¢ revenue_   â”‚ â”‚
â”‚  â”‚   _scoped()     â”‚  â”‚   _analysis()   â”‚  â”‚                 â”‚  â”‚   _tracking()â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ”’ ALL REPOSITORIES: Automatic organization_id filtering                       â”‚
â”‚  ğŸ”’ NO CROSS-ORG QUERIES: Every method validates organization context          â”‚
â”‚  ğŸ”’ PERFORMANCE OPTIMIZED: Indexes on organization_id + business fields       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
INFRASTRUCTURE LAYER (Models & Database)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SQLALCHEMY MODELS                                     â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ“‹ 30 Tables Total:                                                            â”‚
â”‚  â€¢ 6 Foundation (orgs, users, members, subscriptions, jobs, audit)             â”‚
â”‚  â€¢ 8 Business (leads, stages, activities, templates, scoring, etc)             â”‚
â”‚  â€¢ 6 Communication (whatsapp_configs, messages, attachments, calls, etc)       â”‚
â”‚  â€¢ 4 AI/ML (conversations, training_data, models, analytics)                   â”‚
â”‚  â€¢ 6 Integration (calendar, marketing, api_keys, webhooks, etc)                â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ”’ Multi-Tenancy Pattern on ALL Business Tables:                              â”‚
â”‚    organization_id = Column(UUID, ForeignKey("organizations.id"))              â”‚
â”‚    __table_args__ = (Index('ix_table_org_id', 'organization_id'),)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 8. Deployment Architecture

### Railway Production Environment

```
RAILWAY DEPLOYMENT ARCHITECTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           RAILWAY PRODUCTION                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FRONTEND SERVICE (Next.js 14)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        frontend-production.up.railway.app                      â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚  Environment Variables:                                                         â”‚
â”‚  â€¢ NEXT_PUBLIC_API_URL=https://backend-production.up.railway.app               â”‚
â”‚  â€¢ NEXT_PUBLIC_SENTRY_DSN=...                                                  â”‚
â”‚  â€¢ NODE_ENV=production                                                          â”‚
â”‚                                                                                 â”‚
â”‚  Build Configuration:                                                           â”‚
â”‚  â€¢ output: 'standalone' (Docker optimization)                                  â”‚
â”‚  â€¢ TypeScript: ignoreBuildErrors (MVP mode)                                    â”‚
â”‚  â€¢ ESLint: ignoreDuringBuilds (MVP mode)                                       â”‚
â”‚                                                                                 â”‚
â”‚  Request Routing (next.config.js):                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  /api/auth/:path*     â†’ backend/auth/:path*                             â”‚   â”‚
â”‚  â”‚  /api/crm/:path*      â†’ backend/crm/:path*                              â”‚   â”‚
â”‚  â”‚  /api/organizations/* â†’ backend/organizations/:path*                    â”‚   â”‚
â”‚  â”‚  /api/billing/:path*  â†’ backend/billing/:path*                          â”‚   â”‚
â”‚  â”‚  /api/:path*          â†’ backend/:path*                                  â”‚   â”‚
â”‚  â”‚  /docs                â†’ backend/docs                                    â”‚   â”‚
â”‚  â”‚  /health              â†’ backend/health                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼ HTTPS
BACKEND SERVICE (FastAPI)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        backend-production.up.railway.app                       â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚  Environment Variables:                                                         â”‚
â”‚  â€¢ DATABASE_URL=postgresql://user:pass@railway-postgres:5432/railway           â”‚
â”‚  â€¢ REDIS_URL=redis://railway-redis:6379                                        â”‚
â”‚  â€¢ SECRET_KEY=... (32+ chars)                                                  â”‚
â”‚  â€¢ CORS_ORIGINS=["https://frontend-production.up.railway.app"]                 â”‚
â”‚  â€¢ SENTRY_DSN=... (monitoring)                                                 â”‚
â”‚                                                                                 â”‚
â”‚  Health Monitoring:                                                             â”‚
â”‚  â€¢ GET /health â†’ Database + Redis status                                       â”‚
â”‚  â€¢ GET /database/info â†’ Migration status + connection pool                     â”‚
â”‚  â€¢ Automatic Railway health checks                                             â”‚
â”‚                                                                                 â”‚
â”‚  Middleware Stack:                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  SecurityHeaders â†’ OrganizationContext â†’ RateLimit â†’ SentryContext     â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  ğŸ”’ CRITICAL: OrganizationContextMiddleware                            â”‚   â”‚
â”‚  â”‚     â€¢ Validates X-Org-Id header                                        â”‚   â”‚
â”‚  â”‚     â€¢ Ensures JWT org_id matches header                                â”‚   â”‚
â”‚  â”‚     â€¢ Prevents cross-organization access                               â”‚   â”‚
â”‚  â”‚     â€¢ All business endpoints require organization context              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼ Railway Private Network
DATABASE SERVICE (PostgreSQL 16)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PostgreSQL 16 with SSL                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚  Connection Configuration:                                                      â”‚
â”‚  â€¢ SSL Mode: require                                                            â”‚
â”‚  â€¢ Connection Pool: 20 connections                                             â”‚
â”‚  â€¢ Timezone: UTC                                                               â”‚
â”‚  â€¢ Encoding: UTF-8                                                             â”‚
â”‚                                                                                 â”‚
â”‚  Schema Status:                                                                 â”‚
â”‚  â€¢ schema_versions table tracks migrations                                     â”‚
â”‚  â€¢ 30 tables with organization_id isolation                                    â”‚
â”‚  â€¢ 50+ performance indexes                                                     â”‚
â”‚  â€¢ Row-level security via application logic                                    â”‚
â”‚                                                                                 â”‚
â”‚  Monitoring:                                                                    â”‚
â”‚  â€¢ Connection health checks via /database/info                                 â”‚
â”‚  â€¢ Migration status tracking                                                   â”‚
â”‚  â€¢ Query performance monitoring                                                â”‚
â”‚  â€¢ Automated backups by Railway                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

REDIS SERVICE (Caching & Sessions)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Redis Instance                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚  Usage Patterns:                                                                â”‚
â”‚  â€¢ Session storage (JWT blacklisting)                                          â”‚
â”‚  â€¢ Rate limiting counters                                                      â”‚
â”‚  â€¢ Background job queues                                                       â”‚
â”‚  â€¢ AI conversation context caching                                             â”‚
â”‚  â€¢ Real-time WebSocket message queuing                                         â”‚
â”‚                                                                                 â”‚
â”‚  Organization Isolation:                                                        â”‚
â”‚  â€¢ Redis keys prefixed with org_id                                             â”‚
â”‚  â€¢ Session data scoped by organization                                         â”‚
â”‚  â€¢ Cache invalidation per organization                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SSL TERMINATION & SECURITY
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Security Headers                                     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚  Automatic Railway SSL:                                                         â”‚
â”‚  â€¢ TLS 1.2+ enforced                                                           â”‚
â”‚  â€¢ Automatic certificate management                                            â”‚
â”‚  â€¢ HSTS headers                                                                â”‚
â”‚  â€¢ Secure cookie settings                                                      â”‚
â”‚                                                                                 â”‚
â”‚  Custom Security Headers (SecurityHeadersMiddleware):                          â”‚
â”‚  â€¢ X-Frame-Options: DENY                                                       â”‚
â”‚  â€¢ X-Content-Type-Options: nosniff                                             â”‚
â”‚  â€¢ Referrer-Policy: origin-when-cross-origin                                   â”‚
â”‚  â€¢ Content-Security-Policy: strict                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Monitoring and Observability

```
PRODUCTION MONITORING STACK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ERROR TRACKING (Sentry)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Sentry Integration                                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚  Frontend Monitoring:                                                           â”‚
â”‚  â€¢ JavaScript errors and exceptions                                            â”‚
â”‚  â€¢ Performance monitoring (Core Web Vitals)                                    â”‚
â”‚  â€¢ User session tracking                                                       â”‚
â”‚  â€¢ Custom organization context in errors                                       â”‚
â”‚                                                                                 â”‚
â”‚  Backend Monitoring:                                                            â”‚
â”‚  â€¢ Python exception tracking                                                   â”‚
â”‚  â€¢ API performance monitoring                                                  â”‚
â”‚  â€¢ Database query performance                                                  â”‚
â”‚  â€¢ Organization context in all errors                                          â”‚
â”‚                                                                                 â”‚
â”‚  Multi-Tenant Error Context:                                                   â”‚
â”‚  â€¢ All errors tagged with organization_id                                      â”‚
â”‚  â€¢ User identification with org context                                        â”‚
â”‚  â€¢ Request tracing across frontend/backend                                     â”‚
â”‚  â€¢ Custom dashboards per organization tier                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

APPLICATION PERFORMANCE MONITORING
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Health Check Endpoints                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚  GET /health:                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  {                                                                      â”‚   â”‚
â”‚  â”‚    "status": "healthy",                                                 â”‚   â”‚
â”‚  â”‚    "service": "Loved CRM API",                                          â”‚   â”‚
â”‚  â”‚    "version": "1.0.0",                                                  â”‚   â”‚
â”‚  â”‚    "timestamp": 1642253400,                                             â”‚   â”‚
â”‚  â”‚    "dependencies": {                                                    â”‚   â”‚
â”‚  â”‚      "database": {                                                      â”‚   â”‚
â”‚  â”‚        "status": "healthy",                                             â”‚   â”‚
â”‚  â”‚        "response_time_ms": 15.2,                                        â”‚   â”‚
â”‚  â”‚        "type": "postgresql"                                             â”‚   â”‚
â”‚  â”‚      },                                                                 â”‚   â”‚
â”‚  â”‚      "redis": {                                                         â”‚   â”‚
â”‚  â”‚        "status": "healthy",                                             â”‚   â”‚
â”‚  â”‚        "response_time_ms": 2.1,                                         â”‚   â”‚
â”‚  â”‚        "type": "redis"                                                  â”‚   â”‚
â”‚  â”‚      }                                                                  â”‚   â”‚
â”‚  â”‚    },                                                                   â”‚   â”‚
â”‚  â”‚    "response_time_ms": 23.8                                             â”‚   â”‚
â”‚  â”‚  }                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  GET /database/info:                                                            â”‚
â”‚  â€¢ Database version information                                                â”‚
â”‚  â€¢ Connection pool status                                                      â”‚
â”‚  â€¢ Migration status and latest version                                         â”‚
â”‚  â€¢ Performance metrics                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

LOGS & METRICS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Structured Logging                                    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                                                                 â”‚
â”‚  Log Format (JSON):                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  {                                                                      â”‚   â”‚
â”‚  â”‚    "timestamp": "2024-01-15T10:30:00Z",                                 â”‚   â”‚
â”‚  â”‚    "level": "INFO",                                                     â”‚   â”‚
â”‚  â”‚    "logger": "api.services.crm_leads",                                  â”‚   â”‚
â”‚  â”‚    "message": "Lead created successfully",                              â”‚   â”‚
â”‚  â”‚    "organization_id": "uuid-123",                                       â”‚   â”‚
â”‚  â”‚    "user_id": "uuid-456",                                               â”‚   â”‚
â”‚  â”‚    "lead_id": "uuid-789",                                               â”‚   â”‚
â”‚  â”‚    "request_id": "correlation-uuid",                                    â”‚   â”‚
â”‚  â”‚    "extra_context": {                                                   â”‚   â”‚
â”‚  â”‚      "lead_score": 85,                                                  â”‚   â”‚
â”‚  â”‚      "source": "whatsapp",                                              â”‚   â”‚
â”‚  â”‚      "assigned_to": "user-uuid"                                         â”‚   â”‚
â”‚  â”‚    }                                                                    â”‚   â”‚
â”‚  â”‚  }                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  Key Metrics Tracked:                                                          â”‚
â”‚  â€¢ API response times per endpoint                                             â”‚
â”‚  â€¢ Database query performance                                                  â”‚
â”‚  â€¢ Organization-scoped error rates                                             â”‚
â”‚  â€¢ WebSocket connection statistics                                             â”‚
â”‚  â€¢ Background job processing times                                             â”‚
â”‚  â€¢ External service integration health                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 9. Security and Multi-Tenancy

### Organization Isolation Patterns

```
MULTI-TENANT SECURITY ARCHITECTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ORGANIZATION DATA ISOLATION                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

REQUEST FLOW SECURITY:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client Request    â”‚â”€â”€â”€â–¶â”‚   Middleware        â”‚â”€â”€â”€â–¶â”‚   Business Logic    â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚   Validation        â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚ Headers:            â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ Organization        â”‚
â”‚ â€¢ Authorization:    â”‚    â”‚ 1. JWT Valid?       â”‚    â”‚ Context Required:   â”‚
â”‚   Bearer jwt_token  â”‚    â”‚ 2. X-Org-Id Valid?  â”‚    â”‚                     â”‚
â”‚ â€¢ X-Org-Id:         â”‚    â”‚ 3. Org Match JWT?   â”‚    â”‚ @requires_org       â”‚
â”‚   uuid-123          â”‚    â”‚ 4. User in Org?     â”‚    â”‚ def endpoint(       â”‚
â”‚ â€¢ Content-Type:     â”‚    â”‚ 5. Permissions OK?  â”‚    â”‚   org: Organization â”‚
â”‚   application/json  â”‚    â”‚                     â”‚    â”‚ ) -> Response:      â”‚
â”‚                     â”‚    â”‚ âœ… PASS â†’ Continue  â”‚    â”‚   # org is validatedâ”‚
â”‚                     â”‚    â”‚ âŒ FAIL â†’ 403/401   â”‚    â”‚   # and injected    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                                     â–¼
DATABASE ISOLATION:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          AUTOMATIC ORG FILTERING                               â”‚
â”‚                                                                                 â”‚
â”‚  âœ… SECURE (Organization-scoped):                                              â”‚
â”‚  SELECT * FROM leads WHERE organization_id = 'uuid-123';                       â”‚
â”‚  UPDATE leads SET status = 'active' WHERE id = ? AND organization_id = ?;      â”‚
â”‚  DELETE FROM leads WHERE id = ? AND organization_id = ?;                       â”‚
â”‚                                                                                 â”‚
â”‚  âŒ INSECURE (Cross-organization risk):                                        â”‚
â”‚  SELECT * FROM leads WHERE id = ?;  -- Missing org filter!                    â”‚
â”‚  SELECT * FROM leads;               -- No filtering at all!                   â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ”’ PREVENTION MECHANISMS:                                                     â”‚
â”‚  â€¢ Repository pattern enforces organization filtering                          â”‚
â”‚  â€¢ All business models include organization_id FK                             â”‚
â”‚  â€¢ Database indexes optimize org-scoped queries                               â”‚
â”‚  â€¢ Unit tests verify cross-org prevention                                     â”‚
â”‚                                                                                 â”‚
â”‚  ğŸ“Š PERFORMANCE OPTIMIZATION:                                                  â”‚
â”‚  â€¢ Primary index: (organization_id, created_at)                               â”‚
â”‚  â€¢ Business indexes: (organization_id, stage_id, lead_score)                  â”‚
â”‚  â€¢ Query execution plans optimized for org filtering                          â”‚
â”‚  â€¢ Connection pooling respects org-based traffic patterns                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SECURITY BOUNDARIES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            ACCESS CONTROL                                      â”‚
â”‚                                                                                 â”‚
â”‚  Authentication Layers:                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  1. JWT Token Validation (user identity)                               â”‚   â”‚
â”‚  â”‚  2. Organization Membership (user in org?)                             â”‚   â”‚
â”‚  â”‚  3. Role-Based Permissions (admin, manager, sales, viewer)             â”‚   â”‚
â”‚  â”‚  4. Feature Gates (plan tier restrictions)                             â”‚   â”‚
â”‚  â”‚  5. Rate Limiting (per organization limits)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  Cross-Organization Attack Prevention:                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Scenario: Malicious user tries to access other org's data             â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Attack Vector 1: Modify X-Org-Id header                               â”‚   â”‚
â”‚  â”‚  âœ… Prevention: JWT org_id must match header org_id                    â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Attack Vector 2: Guess other organization's UUIDs                     â”‚   â”‚
â”‚  â”‚  âœ… Prevention: User must be member of organization                    â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Attack Vector 3: Parameter manipulation in URLs                       â”‚   â”‚
â”‚  â”‚  âœ… Prevention: All resources validated against org_id                 â”‚   â”‚
â”‚  â”‚                                                                         â”‚   â”‚
â”‚  â”‚  Attack Vector 4: Database injection attacks                           â”‚   â”‚
â”‚  â”‚  âœ… Prevention: Parameterized queries + org_id always included         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AUDIT AND COMPLIANCE:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              AUDIT TRAIL                                       â”‚
â”‚                                                                                 â”‚
â”‚  Every Action Logged:                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  {                                                                      â”‚   â”‚
â”‚  â”‚    "id": "audit-uuid",                                                  â”‚   â”‚
â”‚  â”‚    "organization_id": "uuid-123",                                       â”‚   â”‚
â”‚  â”‚    "user_id": "uuid-456",                                               â”‚   â”‚
â”‚  â”‚    "action": "lead_updated",                                            â”‚   â”‚
â”‚  â”‚    "resource_type": "lead",                                             â”‚   â”‚
â”‚  â”‚    "resource_id": "uuid-789",                                           â”‚   â”‚
â”‚  â”‚    "ip_address": "192.168.1.1",                                         â”‚   â”‚
â”‚  â”‚    "user_agent": "Mozilla/5.0...",                                      â”‚   â”‚
â”‚  â”‚    "changes": {                                                         â”‚   â”‚
â”‚  â”‚      "before": {"stage_id": "uuid-old"},                               â”‚   â”‚
â”‚  â”‚      "after": {"stage_id": "uuid-new"}                                 â”‚   â”‚
â”‚  â”‚    },                                                                   â”‚   â”‚
â”‚  â”‚    "success": true,                                                     â”‚   â”‚
â”‚  â”‚    "timestamp": "2024-01-15T10:30:00Z"                                  â”‚   â”‚
â”‚  â”‚  }                                                                      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                 â”‚
â”‚  Security Events Monitoring:                                                   â”‚
â”‚  â€¢ Failed cross-organization access attempts                                   â”‚
â”‚  â€¢ Suspicious authentication patterns                                          â”‚
â”‚  â€¢ Bulk data export operations                                                 â”‚
â”‚  â€¢ API key usage anomalies                                                     â”‚
â”‚  â€¢ Privilege escalation attempts                                               â”‚
â”‚                                                                                 â”‚
â”‚  LGPD/GDPR Compliance:                                                         â”‚
â”‚  â€¢ Data export capabilities per organization                                   â”‚
â”‚  â€¢ Right to deletion with cascade handling                                     â”‚
â”‚  â€¢ Data processing consent tracking                                            â”‚
â”‚  â€¢ Cross-border data transfer logging                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 10. Diagram Conventions and Legends

### Symbol Definitions

```
DIAGRAM LEGEND & CONVENTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            SYMBOL MEANINGS                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

RELATIONSHIP NOTATION:
â”€â”€â”€â–¶  : Data Flow (Request)                    â—€â”€â”€â”€  : Response Flow
â•â•â•â–¶  : Secure/Encrypted Flow                 â•‹     : Decision Point
â”â”â”â–¶  : Multi-tenant Isolated Flow            â–¼     : Process Flow
â”…â”…â”…â–¶  : Optional/Conditional Flow             â”‚     : Connection
                                              â””â”€ â”¬ â”€â”˜ : Alternative Paths

COMPONENT TYPES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” : Service/Component        [USER ACTION] : User Interaction
â”‚     Service     â”‚                            {Business}   : Business Logic  
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                            (Database)   : Data Storage
â”‚ â€¢ Function 1    â”‚                            <External>   : External Service
â”‚ â€¢ Function 2    â”‚                            |Internal|   : Internal Process
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SECURITY & ISOLATION:
ğŸ”’ : Security Layer                           ğŸ”´ : Critical/Required
ğŸ”‘ : Authentication Required                  âš ï¸  : Warning/Risk
ğŸ›¡ï¸ : Organization Isolation                  âœ… : Validated/Secure
ğŸ‘¤ : User Context                             âŒ : Forbidden/Blocked
ğŸ¢ : Organization Context                     ğŸ¯ : Business Goal

STATUS INDICATORS:
âœ… : Implemented/Working                      ğŸ†• : New/To Be Built
âš ï¸ : Alternative/Risky                       ğŸ”„ : In Progress  
âŒ : Not Recommended                         ğŸ“‹ : Documentation
ğŸš€ : Performance Optimized                   ğŸ§ª : Testing Required
```

### Reading Guide

```
HOW TO READ THESE DIAGRAMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          INTERPRETATION GUIDE                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. SYSTEM ARCHITECTURE DIAGRAMS:
   â€¢ Read top-to-bottom: User â†’ Frontend â†’ Backend â†’ Database
   â€¢ Organization isolation shown with ğŸ”’ symbols
   â€¢ Multi-tenant data flow marked with â•â•â•â–¶
   â€¢ Critical security layers highlighted with ğŸ”´

2. DATABASE SCHEMA DIAGRAMS:
   â€¢ Primary keys shown as (PK)
   â€¢ Foreign keys shown as (FK) with arrows
   â€¢ Organization relationships marked with ğŸ¢
   â€¢ Indexes listed in __table_args__ sections
   â€¢ Multi-tenant isolation via organization_id filtering

3. API FLOW DIAGRAMS:
   â€¢ Headers section shows required authentication
   â€¢ Middleware validation steps numbered 1-5
   â€¢ Success path shown with âœ… symbols
   â€¢ Error responses shown with âŒ symbols
   â€¢ Organization context validation at each layer

4. USER JOURNEY DIAGRAMS:
   â€¢ Left-to-right flow: User Action â†’ System Response
   â€¢ Edge cases listed below main flow
   â€¢ Real-time updates shown with broadcast symbols
   â€¢ Organization scope maintained throughout journey

5. INTEGRATION DIAGRAMS:
   â€¢ External services marked with dashed borders
   â€¢ OAuth flows shown with token exchange arrows
   â€¢ Webhook patterns displayed with callback flows
   â€¢ Provider options shown as alternative paths

MULTI-TENANCY VISUAL PATTERNS:
â€¢ ğŸ¢ Organization context always present in business operations
â€¢ ğŸ”’ Security validation at each layer boundary  
â€¢ â•â•â• Org-isolated data flow vs â”€â”€â”€â”€ general data flow
â€¢ All business tables include organization_id relationships
â€¢ Cross-org access prevention marked with âŒ symbols
```

---

<function_calls>
<invoke name="TodoWrite">
<parameter name="todos">[{"id": "diagram_analysis", "content": "Analyze all documentation files to understand system architecture and features", "status": "completed"}, {"id": "codebase_verification", "content": "Verify current template structure and components available", "status": "completed"}, {"id": "diagram_generation", "content": "Generate comprehensive technical diagrams for all system components", "status": "completed"}]