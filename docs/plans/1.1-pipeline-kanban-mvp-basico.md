# Plano de ExecuÃ§Ã£o: 1.1 - Pipeline Kanban MVP BÃ¡sico

## ðŸŽ¯ DESCOBERTA CRÃTICA BASEADA NA ANÃLISE REAL DO CODEBASE

### **âœ… FUNCIONALIDADES JÃ IMPLEMENTADAS (90%+ COMPLETO):**

1. **@dnd-kit/core**: âœ… JÃ IMPLEMENTADO no `pipeline-kanban.tsx`
2. **Backend API**: âœ… Endpoint `/crm/leads/{id}/stage` JÃ EXISTE no `crm_leads.py`
3. **WebSocket Infrastructure**: âœ… JÃ EXISTE (`websocket_manager.py` + `websocket.py`)
4. **Database Schema**: âœ… Lead model + PipelineStage enum JÃ EXISTE
5. **Service Layer**: âœ… `moveLeadToStage()` JÃ IMPLEMENTADO
6. **Multi-tenancy**: âœ… Organization isolation JÃ IMPLEMENTADO

### **ðŸš¨ GAPS IDENTIFICADOS (apenas 10% faltante):**

1. **WebSocket especÃ­fico para Pipeline**: Falta endpoint `/ws/crm/pipeline`
2. **Broadcasting lead stage changes**: Falta integraÃ§Ã£o WebSocket no CRMLeadService
3. **Frontend WebSocket connection**: Falta conectar pipeline-kanban com WebSocket
4. **Performance indexes**: Falta composite index para queries de stage
5. **E2E Tests**: Falta testes especÃ­ficos para drag-drop + multi-tenancy

---

## ðŸ“‹ PLANO DE EXECUÃ‡ÃƒO DETALHADO

### **STEP 1: Implementar WebSocket Pipeline-Specific Endpoint**

**Arquivo:** `api/routers/websocket.py`
**Tempo:** 2 horas
**AÃ§Ã£o:**

```python
@router.websocket("/pipeline")
async def websocket_pipeline_endpoint(
    websocket: WebSocket,
    token: str = Query(..., description="JWT access token"),
    org_id: str = Query(..., description="Organization ID")
):
    """WebSocket especÃ­fico para updates do Pipeline Kanban"""
```

### **STEP 2: Integrar Broadcasting no CRMLeadService**

**Arquivo:** `api/services/crm_lead_service.py`
**Tempo:** 3 horas
**AÃ§Ã£o:**

```python
# ApÃ³s stage update, broadcast via WebSocket:
await websocket_manager.broadcast_to_organization(
    organization.id,
    {
        "type": "lead_stage_changed",
        "lead_id": str(lead.id),
        "old_stage": old_stage,
        "new_stage": new_stage,
        "user_id": str(user.id),
        "timestamp": datetime.utcnow().isoformat()
    }
)
```

### **STEP 3: Conectar Frontend WebSocket no Pipeline**

**Arquivo:** `components/crm/pipeline-kanban.tsx`
**Tempo:** 4 horas
**AÃ§Ã£o:**

```typescript
// Adicionar WebSocket hook:
const { socket, isConnected } = useWebSocket("/api/ws/pipeline")

// Listener para stage changes:
useEffect(() => {
  if (socket) {
    socket.on("lead_stage_changed", data => {
      // Update local state sem reload
    })
  }
}, [socket])
```

### **STEP 4: Otimizar Performance Database**

**Arquivo:** Nova migration
**Tempo:** 1 hora
**AÃ§Ã£o:**

```sql
CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_leads_org_stage
ON leads (organization_id, stage);
```

### **STEP 5: Implementar E2E Tests**

**Arquivo:** `tests/e2e/api/test_pipeline_realtime.py`
**Tempo:** 3 horas
**AÃ§Ã£o:**

- Teste drag-drop multi-usuÃ¡rio
- Teste isolation entre organizaÃ§Ãµes
- Teste performance com 100+ leads

### **STEP 6: IntegraÃ§Ã£o e Deploy**

**Tempo:** 2 horas
**AÃ§Ã£o:**

- Testes de integraÃ§Ã£o completos
- Deploy em ambiente de teste
- ValidaÃ§Ã£o funcional completa

---

## ðŸ“Š CRONOGRAMA E ESFORÃ‡O

### **Timeline Total: 15 horas (2 dias)**

| Step | DescriÃ§Ã£o                     | Tempo | DependÃªncias     |
| ---- | ----------------------------- | ----- | ---------------- |
| 1    | WebSocket Pipeline Endpoint   | 2h    | Nenhuma          |
| 2    | Broadcasting Integration      | 3h    | Step 1           |
| 3    | Frontend WebSocket Connection | 4h    | Step 1,2         |
| 4    | Performance Database Index    | 1h    | Nenhuma          |
| 5    | E2E Tests                     | 3h    | Step 1,2,3       |
| 6    | IntegraÃ§Ã£o e Deploy           | 2h    | Todos anteriores |

### **Critical Path: Steps 1 â†’ 2 â†’ 3 â†’ 6**

---

## âœ… CRITÃ‰RIOS DE ACEITE

### **AC1: Drag & Drop Funcional**

- [x] âœ… **IMPLEMENTADO**: Kanban com 5 stages
- [x] âœ… **IMPLEMENTADO**: Drag & drop entre stages
- [ ] **FALTANTE**: Real-time updates para outros usuÃ¡rios

### **AC2: AtualizaÃ§Ãµes em Tempo Real**

- [x] âœ… **IMPLEMENTADO**: WebSocket infrastructure
- [ ] **FALTANTE**: Pipeline-specific broadcasting
- [ ] **FALTANTE**: Frontend WebSocket integration

### **AC3: Multi-tenancy Garantido**

- [x] âœ… **IMPLEMENTADO**: Organization-scoped data
- [x] âœ… **IMPLEMENTADO**: X-Org-Id headers
- [x] âœ… **IMPLEMENTADO**: JWT with org context

### **AC4: Performance Otimizada**

- [x] âœ… **IMPLEMENTADO**: Optimistic UI updates
- [ ] **FALTANTE**: Database composite indexes
- [ ] **FALTANTE**: E2E performance tests

---

## ðŸ”§ ARQUIVOS A MODIFICAR

### **Backend (3 arquivos)**

1. `api/routers/websocket.py` - Adicionar endpoint `/pipeline`
2. `api/services/crm_lead_service.py` - Adicionar broadcasting
3. `migrations/` - Nova migration para indexes

### **Frontend (1 arquivo)**

4. `components/crm/pipeline-kanban.tsx` - Integrar WebSocket

### **Tests (1 arquivo)**

5. `tests/e2e/api/test_pipeline_realtime.py` - Testes E2E

---

## ðŸš¨ RISCOS E MITIGAÃ‡Ã•ES

### **RISCO 1: WebSocket Connection Instability**

**Probabilidade:** MÃ©dia
**Impacto:** Alto
**MitigaÃ§Ã£o:** Implementar reconnection logic + fallback to polling

### **RISCO 2: Performance Degradation com Muitos UsuÃ¡rios**

**Probabilidade:** Baixa
**Impacto:** MÃ©dio
**MitigaÃ§Ã£o:** Rate limiting + connection pooling

### **RISCO 3: Multi-tenancy Breach via WebSocket**

**Probabilidade:** Muito Baixa
**Impacto:** CrÃ­tico
**MitigaÃ§Ã£o:** JWT validation + org_id checking em cada message

---

## ðŸŽ‰ RESULTADO ESPERADO

### **Pipeline Kanban Completo e Funcional:**

- âœ… Drag & drop suave e responsivo
- âœ… Updates em tempo real para toda equipe
- âœ… Isolamento perfeito entre organizaÃ§Ãµes
- âœ… Performance otimizada para 100+ leads
- âœ… Testes E2E cobrindo casos crÃ­ticos

### **MÃ©tricas de Sucesso:**

- **LatÃªncia**: < 100ms para updates WebSocket
- **Throughput**: 1000+ concurrent connections por org
- **Availability**: 99.9% uptime
- **Security**: Zero vazamentos entre organizaÃ§Ãµes

---

## ðŸ“ NOTAS TÃ‰CNICAS

### **PadrÃ£o WebSocket Usado:**

```typescript
// PadrÃ£o de mensagem:
{
  "type": "lead_stage_changed",
  "lead_id": "uuid",
  "old_stage": "lead",
  "new_stage": "contato",
  "organization_id": "uuid",
  "user_id": "uuid",
  "timestamp": "2025-01-07T10:30:00Z"
}
```

### **Performance Index:**

```sql
-- Otimizar queries: WHERE organization_id = ? AND stage = ?
CREATE INDEX CONCURRENTLY idx_leads_org_stage
ON leads (organization_id, stage);
```

### **Multi-tenancy Check:**

```python
# ValidaÃ§Ã£o obrigatÃ³ria em todo WebSocket message:
if message_org_id != authenticated_org_id:
    raise HTTPException(403, "Organization access denied")
```

---

**Status:** âœ… **PRONTO PARA IMPLEMENTAÃ‡ÃƒO**  
**Certeza:** ðŸŽ¯ **95%+ - AnÃ¡lise completa do codebase realizada**  
**Complexidade:** ðŸŸ¡ **BAIXA - 90% jÃ¡ implementado, falta apenas integraÃ§Ã£o**

---

_Gerado automaticamente por Claude Code em 2025-01-07_  
_Baseado em anÃ¡lise real do codebase em `/home/paulo/Projetos/desafio/lovedcrm`_
