# üîê PLANO DE EXECU√á√ÉO: STORY 4.1 - Multi-Tenancy Core MVP B√°sico

> **Data:** 2025-01-12  
> **Status:** PRONTO PARA EXECU√á√ÉO  
> **Estimativa:** 3 dias (24 horas)  
> **Certeza:** 99%

---

## üìã RESUMO EXECUTIVO

### Objetivo da Story

**Como** founder de ag√™ncia B2B  
**Quero** isolamento absoluto entre clientes  
**Para** garantir seguran√ßa de dados

### Estrat√©gia de Implementa√ß√£o

**ENHANCEMENT APPROACH** - Evolu√ß√£o do sistema existente robusto ao inv√©s de cria√ß√£o do zero

### Base S√≥lida Existente (Validada)

‚úÖ **Organization middleware** com X-Org-Id headers  
‚úÖ **Role-based access control** com 4-tier hierarchy (Owner/Admin/Member/Viewer)  
‚úÖ **Audit logging** framework implementado  
‚úÖ **Team management** UI com role changes  
‚úÖ **Multi-tenant database** com organization_id isolation  
‚úÖ **Authentication system** com JWT + Redis blacklist

---

## üéØ CRIT√âRIOS DE ACEITE (ROADMAP)

### Frontend

- [ ] Organization context sempre presente no header
- [ ] Interface baseada em roles (admin/viewer diferenciado)

### Backend

- [ ] Organization middleware obrigat√≥rio em todos endpoints
- [ ] RBAC com hierarchy validation (owner > admin > member > viewer)
- [ ] Audit logging para todas opera√ß√µes sens√≠veis

### Database

- [ ] Todas queries org-scoped automaticamente
- [ ] Tabela audit_logs funcional e populada

### Tests

- [ ] Cross-org access prevention validated
- [ ] Role permissions enforcement tested
- [ ] Audit trail completeness verified

---

## üèóÔ∏è AN√ÅLISE ARQUITETURAL

### Estado Atual Mapeado

#### ‚úÖ RBAC System (api/routers/roles.py)

```python
# ENDPOINTS COMPLETOS EXISTENTES:
PUT /roles/members/{user_id}      # Change member role
DELETE /roles/members/{user_id}   # Remove member
GET /roles/permissions           # Get user permissions
GET /roles/permissions/{user_id} # Get member permissions
GET /roles/summary              # Organization roles summary
GET /roles/manageable           # Get manageable roles
GET /roles/check-permission     # Check specific permission
```

#### ‚úÖ Team Management UI (app/[locale]/admin/team/page.tsx)

```typescript
// COMPONENTES EXISTENTES:
- TeamPageHeader           # Header with invite actions
- TeamStatsCards          # Role distribution stats
- TeamFilters             # Search + role filtering
- MembersList             # Members grid with actions
- RoleChangeDialog        # Role change confirmation
- RemoveMemberDialog      # Member removal confirmation
- useTeamManagement       # Complete state management
```

#### ‚úÖ Organization Middleware (Detectado)

- Headers X-Org-Id enforcement
- Auto organization filtering
- Permission-based access control

---

## üìù PLANO DE EXECU√á√ÉO DETALHADO

### FASE 1: AUDIT ENHANCEMENT (8 horas)

#### 1.1 Audit Service Enhancement (3 horas)

**Arquivo:** `api/services/audit_service.py`

```python
# IMPLEMENTA√á√ïES NECESS√ÅRIAS:
class AuditService:
    async def log_role_change(org_id, target_user, old_role, new_role, manager_user)
    async def log_member_removal(org_id, removed_user, manager_user)
    async def log_organization_access(org_id, user_id, action, details)
    async def get_audit_trail(org_id, filters) -> List[AuditLogEntry]
    async def get_security_events(org_id, timeframe) -> SecurityReport
```

#### 1.2 Audit Router Implementation (2 horas)

**Arquivo:** `api/routers/audit.py`

```python
# ENDPOINTS NOVOS:
GET /audit/trail                # Organization audit trail
GET /audit/security-events      # Security events summary
GET /audit/member-activity       # Member activity log
```

#### 1.3 Audit Integration (3 horas)

**Integra√ß√£o nos endpoints existentes:**

- `api/routers/roles.py` - Log role changes
- `api/routers/organization.py` - Log org operations
- `api/core/organization_middleware.py` - Log access attempts

### FASE 2: FRONTEND ENHANCEMENTS (10 horas)

#### 2.1 Organization Context Header (3 horas)

**Arquivo:** `components/admin/organization-header.tsx`

```typescript
// NOVO COMPONENTE:
interface OrganizationHeaderProps {
  organization: Organization
  user: User
  onSwitchOrganization?: () => void
}
// Features: Org name, role badge, switch button (multi-org users)
```

#### 2.2 Role-Based UI Components (4 horas)

**Arquivos:**

- `components/admin/role-guard.tsx` - Role-based rendering
- `hooks/use-permissions.ts` - Permission checking hook
- `components/admin/restricted-action.tsx` - Permission-gated actions

```typescript
// IMPLEMENTA√á√ïES:
<RoleGuard requiredRole="admin">
  <AdminOnlyButton />
</RoleGuard>

const { hasPermission } = usePermissions()
const canManage = hasPermission('manage_members')
```

#### 2.3 Audit Trail UI (3 horas)

**Arquivo:** `app/[locale]/admin/security/audit/page.tsx`

```typescript
// NOVA P√ÅGINA:
interface AuditTrailPageProps {
  filters: AuditFilters
  timeRange: DateRange
}
// Features: Filterable audit log, export, real-time updates
```

### FASE 3: DATABASE & SECURITY (4 horas)

#### 3.1 Audit Schema Validation (1 hora)

**Arquivo:** `migrations/002_audit_enhancements.sql`

```sql
-- VALIDAR/CRIAR:
CREATE INDEX IF NOT EXISTS idx_audit_logs_org_time
ON audit_logs(organization_id, created_at DESC);

CREATE INDEX IF NOT EXISTS idx_audit_logs_user_action
ON audit_logs(user_id, action);
```

#### 3.2 Query Scope Enforcement (2 horas)

**Arquivo:** `api/core/query_validator.py`

```python
# NOVO UTILIT√ÅRIO:
class QueryScopeValidator:
    @staticmethod
    def ensure_org_scope(query, organization_id):
        """Force organization_id filter in all queries"""

    @staticmethod
    def validate_cross_org_access(user_orgs, requested_org):
        """Prevent cross-organization access"""
```

#### 3.3 Security Headers Enhancement (1 hora)

**Arquivo:** `api/core/security_middleware.py`

```python
# APRIMORAMENTOS:
- Strict org-id validation
- Cross-org request detection
- Suspicious activity logging
```

### FASE 4: TESTING & VALIDATION (2 horas)

#### 4.1 Multi-Tenancy Tests (1 hora)

**Arquivo:** `tests/e2e/api/test_multi_tenancy_security.py`

```python
# TESTES CR√çTICOS:
def test_cross_org_access_prevention()
def test_role_hierarchy_enforcement()
def test_audit_trail_completeness()
def test_organization_context_isolation()
```

#### 4.2 Frontend Permission Tests (1 hora)

**Arquivo:** `tests/frontend/security/permissions.test.tsx`

```typescript
// TESTES UI:
test("role-based component rendering")
test("permission-gated actions")
test("organization context persistence")
```

---

## üöÄ ORDEM DE EXECU√á√ÉO

### DIA 1 (8h) - Backend Foundation

1. **Audit Service Enhancement** (3h)
2. **Audit Router Implementation** (2h)
3. **Audit Integration** (3h)

### DIA 2 (8h) - Frontend Experience

1. **Organization Header** (3h)
2. **Role-Based UI Components** (4h)
3. **Database Schema Validation** (1h)

### DIA 3 (8h) - Security & Completion

1. **Audit Trail UI** (3h)
2. **Query Scope Enforcement** (2h)
3. **Security Middleware** (1h)
4. **Testing & Validation** (2h)

---

## üìä ARQUIVOS IMPACTADOS

### üìÅ Novos Arquivos (6)

```
api/services/audit_service.py
api/routers/audit.py
components/admin/organization-header.tsx
components/admin/role-guard.tsx
hooks/use-permissions.ts
app/[locale]/admin/security/audit/page.tsx
```

### üìù Arquivos Modificados (5)

```
api/routers/roles.py              # +audit integration
api/core/organization_middleware.py # +enhanced logging
api/main.py                       # +audit router
app/[locale]/admin/layout.tsx     # +organization header
components/admin/sidebar.tsx      # +security menu item
```

### üß™ Arquivos de Teste (2)

```
tests/e2e/api/test_multi_tenancy_security.py
tests/frontend/security/permissions.test.tsx
```

---

## ‚ö° COMANDOS DE QUALIDADE

### Desenvolvimento

```bash
npm run quality              # ESLint + TypeScript
python3 -m pytest tests/e2e/api/test_multi_tenancy_security.py -v
```

### Valida√ß√£o Final

```bash
npm run ci:quick             # Quality gates
npm run test:e2e:api         # E2E API tests
npm run security             # Security scan
```

---

## üîí CRIT√âRIOS DE SUCESSO

### ‚úÖ Funcional

- [ ] Cross-organization access **IMPOSS√çVEL**
- [ ] Role hierarchy **RESPEITADA** em 100% endpoints
- [ ] Audit trail **COMPLETO** para todas opera√ß√µes
- [ ] UI **ADAPTADA** por role automaticamente

### ‚úÖ T√©cnico

- [ ] **ZERO** queries sem organization_id filter
- [ ] **100%** endpoints com org middleware
- [ ] **95%+** test coverage em security tests
- [ ] **ZERO** security findings em bandit scan

### ‚úÖ Experi√™ncia

- [ ] Organization context **SEMPRE VIS√çVEL**
- [ ] Role permissions **TRANSPARENTES** para usu√°rio
- [ ] Audit trail **ACESS√çVEL** para admins
- [ ] Performance **MANTIDA** (< 200ms endpoints)

---

## üö® RISCOS E MITIGA√á√ïES

### üî¥ ALTO RISCO

- **Performance degradation** com audit logging
  - **Mitiga√ß√£o:** Async logging + Redis buffer
- **Complex role hierarchy bugs**
  - **Mitiga√ß√£o:** Comprehensive unit tests

### üü° M√âDIO RISCO

- **UI complexity increase**
  - **Mitiga√ß√£o:** Gradual rollout + user feedback

---

## üìà PR√ìXIMOS PASSOS (P√≥s-Story)

1. **Advanced Audit Analytics** (Story 4.2)
2. **Multi-Organization User Support** (Story 4.3)
3. **Advanced Security Policies** (Story 4.4)

---

**PRONTO PARA EXECU√á√ÉO** ‚úÖ  
**Certeza: 99%** | **Riscos: MAPEADOS** | **Dependencies: ZERO**
