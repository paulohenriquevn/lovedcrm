# PLANO DE EXECU√á√ÉO: 6.1 - Templates System MVP B√°sico

## üìä Status da An√°lise

- **Hist√≥ria Localizada**: ‚úÖ `docs/project/11-roadmap.md` - 6.1 encontrada
- **Refinement Carregado**: ‚úÖ `docs/refined/6.1-templates-system-mvp.md` analisado
- **Codebase Analisado**: ‚úÖ Dependencies + Schema + Architecture mapeados
- **Dependencies Validadas**: ‚úÖ 15 frontend + 12 backend libraries confirmadas
- **Multi-tenancy Validated**: ‚úÖ Organization patterns identificados
- **Evidence Collected**: ‚úÖ 8 arquivos lidos + 6 comandos executados
- **Plano Gerado**: ‚úÖ 15 steps detalhados com 18h estimativa total

---

## üéØ **HIST√ìRIA ORIGINAL (ROADMAP)**

### **üìã Crit√©rios de Aceite Preservados**

```yaml
Hist√≥ria: 6.1 - Templates System MVP B√°sico
√âpico: Epic 6 - Supporting Features (Templates)
Estimativa: 3 days

Crit√©rios de Aceite (EXATAMENTE como no roadmap):
  ‚úÖ Admin/Manager acessa template library e clica em "Criar Template"
  ‚úÖ Sistema apresenta categorias (greeting, follow-up, objection, closing)
  ‚úÖ Admin escreve template e insere vari√°veis ({{lead_name}}, {{company}}, {{value}})
  ‚úÖ Sistema salva template com organization_id filtering
  ‚úÖ Admin configura team access permissions para o template
  ‚úÖ Vendedor est√° respondendo lead e come√ßa digitando mensagem
  ‚úÖ Sistema detecta contexto e sugere templates relevantes automaticamente
  ‚úÖ Vendedor seleciona template sugerido
  ‚úÖ Sistema faz variable auto-population com dados do lead
  ‚úÖ Vendedor v√™ message preview com personaliza√ß√£o completa
  ‚úÖ Vendedor envia mensagem e sistema atualiza performance metrics do template

Business Value: 60% redu√ß√£o no tempo de resposta + messaging consistency
User Impact: Sales Representatives respondem leads 3x mais r√°pido
```

---

## üîß **REFINAMENTO T√âCNICO INTEGRADO**

### **üíé Decis√µes T√©cnicas Validadas (do exec-refine)**

```yaml
Refinement Source: docs/refined/6.1-templates-system-mvp.md
Status: ‚úÖ Completo com 99% certeza t√©cnica

Libraries Escolhidas:
  Frontend: React Hook Form ^7.61.1, Zod ^3.25.76, shadcn/ui completo
  Backend: Jinja2 3.1.3 (template engine), SQLAlchemy 2.0.23, FastAPI 0.111.1

Compatibilidade Atual:
  ‚úÖ Compatible: Todas libraries j√° instaladas com vers√µes adequadas
  ‚ö†Ô∏è Update Needed: Nenhuma atualiza√ß√£o necess√°ria
  üÜï Install Needed: Nenhuma nova library necess√°ria

Arquitetura Definida:
  Pattern: Extend Existing Foundation (90% j√° implementado)
  Integration: Vertical slice (Model + Service + API + UI)
  Multi-tenancy: Organization isolation via organization_id FK
```

---

## üèóÔ∏è **AN√ÅLISE DO CODEBASE ATUAL**

### **üìä Estado Atual Mapeado (EVID√äNCIAS REAIS)**

```yaml
Dependencies Analysis:
  requirements.txt: FastAPI==0.111.1, SQLAlchemy==2.0.23, Pydantic==2.8.2, Jinja2==3.1.3, Redis==5.0.1
  package.json: Next.js ^14.0.0, React ^18.2.0, React Hook Form ^7.61.1, Zod ^3.25.76

Schema State:
  Migration Status: Current version 4, Database is up to date
  Current Version: 4 (todas migrations aplicadas)
  Tables Relevant: message_templates (J√Å IMPLEMENTADA na 001_consolidated_schema.sql)

Architecture Mapping:
  api/models/: 15 models existentes (mas nenhum message_template.py ainda)
  api/services/: 20 services existentes (mas nenhum template_service.py ainda)
  api/routers/: 15 routers existentes (mas nenhum templates.py ainda)
  components/ui/: 42 componentes shadcn/ui dispon√≠veis (dialog, form, textarea, select, etc.)
  app/[locale]/admin/: Estrutura completa com admin/templates/ directory vazio

Multi-tenancy Validation:
  Organization Models: Todos models com organization_id identificados
  Org Middleware: api/core/deps.py get_current_organization implementado
  Frontend Context: useOrgContext patterns dispon√≠veis
```

---

## üöÄ **PLANO DE IMPLEMENTA√á√ÉO VERTICAL SLICE**

### **üéØ ESTIMATIVA TOTAL: 18 horas (3 days)**

### **üìã VERTICAL SLICE BREAKDOWN**

#### **Slice 1: Database + Backend Core (6h)**

**Step 1: Backend Model Implementation (2h)**

- **Objetivo**: Criar SQLAlchemy model para message_templates table existente
- **Comandos**:
  ```bash
  # An√°lise do pattern existente
  cd /home/paulo/Projetos/desafio/lovedcrm
  cat api/models/crm_lead.py  # Reference pattern
  cat api/models/organization.py  # Organization relationship pattern
  ```
- **Files**: `api/models/message_template.py`
- **Validation**: `python3 -c "from api.models.message_template import MessageTemplate; print('‚úÖ Model imported successfully')"`
- **Rollback**: Remove model file
- **Org-Safety**: organization_id FK obrigat√≥rio + relationship definido

**Step 2: Backend Service Layer (3h)**

- **Objetivo**: Implementar TemplateService com CRUD operations + variable substitution
- **Comandos**:
  ```python
  # Baseado no pattern de api/services/crm_lead_service.py
  cd /home/paulo/Projetos/desafio/lovedcrm/api/services
  # Implementar CRUD + variable engine com Jinja2
  ```
- **Files**: `api/services/template_service.py`
- **Validation**: `python3 -c "from api.services.template_service import TemplateService; print('‚úÖ Service imported successfully')"`
- **Rollback**: Remove service file
- **Org-Safety**: All queries incluem organization_id filtering autom√°tico

**Step 3: Backend API Router (1h)**

- **Objetivo**: Criar API endpoints /templates/\* com organization dependency
- **Comandos**:
  ```python
  # Baseado no pattern de api/routers/crm_leads.py
  cd /home/paulo/Projetos/desafio/lovedcrm/api/routers
  # Implementar GET/POST/PUT/DELETE endpoints
  ```
- **Files**: `api/routers/templates.py`
- **Validation**: `curl -H "X-Org-Id: test" http://localhost:8000/templates/` returns 200
- **Rollback**: Remove router file + main.py import
- **Org-Safety**: get_current_organization dependency em todos endpoints

#### **Slice 2: Backend Integration + Testing (2h)**

**Step 4: FastAPI Main App Integration (0.5h)**

- **Objetivo**: Registrar template router no FastAPI main app
- **Comandos**:
  ```python
  # Adicionar em api/main.py
  from api.routers import templates
  app.include_router(templates.router, prefix="/api/v1")
  ```
- **Files**: `api/main.py` (edit)
- **Validation**: `curl http://localhost:8000/docs` shows template endpoints
- **Rollback**: Remove router import + include_router line
- **Org-Safety**: Router prefix padronizado

**Step 5: Backend API Testing (1.5h)**

- **Objetivo**: Testar CRUD operations com organization isolation
- **Comandos**:

  ```bash
  # Start API server
  cd /home/paulo/Projetos/desafio/lovedcrm
  python3 -m uvicorn api.main:app --reload

  # Test endpoints with curl
  curl -X POST -H "X-Org-Id: test-org" -H "Content-Type: application/json" \
    -d '{"name":"Test Template","category":"greeting","content":"Hello {{lead_name}}"}' \
    http://localhost:8000/api/v1/templates/
  ```

- **Files**: None (testing only)
- **Validation**: All CRUD operations work + organization isolation confirmed
- **Rollback**: N/A (testing phase)
- **Org-Safety**: Cross-org access returns 403 + audit trail

#### **Slice 3: Frontend Foundation (5h)**

**Step 6: Frontend API Service (1h)**

- **Objetivo**: Criar template API integration service com org headers
- **Comandos**:
  ```typescript
  // Baseado no pattern de services/crm-leads.ts
  cd / home / paulo / Projetos / desafio / lovedcrm / services
  // Implementar templateApi com BaseService pattern
  ```
- **Files**: `services/template-api.ts`
- **Validation**: `npm run typecheck` passes for new service
- **Rollback**: Remove service file
- **Org-Safety**: X-Org-Id headers autom√°ticos via BaseService

**Step 7: Frontend Types & Schemas (1h)**

- **Objetivo**: Definir TypeScript types + Zod schemas para templates
- **Comandos**:
  ```typescript
  // Baseado no pattern de types/crm.ts
  cd / home / paulo / Projetos / desafio / lovedcrm / types
  // Definir Template, TemplateCreate, TemplateUpdate interfaces
  ```
- **Files**: `types/template.ts`, `schemas/template.ts`
- **Validation**: `npm run typecheck` confirms type safety
- **Rollback**: Remove type files
- **Org-Safety**: Organization context inclu√≠do em types

**Step 8: Frontend Hooks Implementation (1h)**

- **Objetivo**: Implementar useTemplates hook com TanStack Query
- **Comandos**:
  ```typescript
  // Baseado no pattern de hooks/use-crm-leads.ts
  cd / home / paulo / Projetos / desafio / lovedcrm / hooks
  // Implementar CRUD operations + caching + invalidation
  ```
- **Files**: `hooks/use-templates.ts`
- **Validation**: `npm run typecheck` + hook imports successfully
- **Rollback**: Remove hook file
- **Org-Safety**: Organization context via useOrgContext integration

**Step 9: Template Management Page (2h)**

- **Objetivo**: Criar main template page /admin/templates com shadcn/ui
- **Comandos**:
  ```tsx
  // Baseado no pattern de app/[locale]/admin/crm/page.tsx
  cd /
    home /
    paulo /
    Projetos /
    desafio /
    lovedcrm /
    app /
    [locale] /
    admin /
    templates
  // Implementar template grid + filters + create dialog
  ```
- **Files**: `app/[locale]/admin/templates/page.tsx`
- **Validation**: Page loads + shows empty state + create button works
- **Rollback**: Remove page file
- **Org-Safety**: Page-level organization context enforcement

#### **Slice 4: Frontend Components + Integration (3h)**

**Step 10: Template CRUD Components (1.5h)**

- **Objetivo**: Implementar template creation/edit dialog + card components
- **Comandos**:
  ```tsx
  // Baseado nos patterns de components/crm/ e components/ui/
  cd /home/paulo/Projetos/desafio/lovedcrm/components/templates
  mkdir -p components/templates
  // TemplateCard, TemplateCreateDialog, TemplateEditDialog
  ```
- **Files**: `components/templates/template-card.tsx`, `components/templates/template-create-form.tsx`
- **Validation**: Components render + form validation works + CRUD operations
- **Rollback**: Remove components directory
- **Org-Safety**: All components use organization context

**Step 11: Variable Substitution UI (1h)**

- **Objetivo**: Implementar variable preview + auto-completion interface
- **Comandos**:
  ```tsx
  // Implementar real-time variable substitution preview
  cd / home / paulo / Projetos / desafio / lovedcrm / components / templates
  // VariablePreview, VariableSelector components
  ```
- **Files**: `components/templates/variable-preview.tsx`, `components/templates/variable-helpers.tsx`
- **Validation**: Real-time preview shows substituted variables correctly
- **Rollback**: Remove variable components
- **Org-Safety**: Variable context isolated per organization

**Step 12: Template Suggestion Integration (0.5h)**

- **Objetivo**: Integrar template suggestions no lead response workflow
- **Comandos**:
  ```tsx
  // Encontrar componente de lead response e adicionar template suggestions
  cd /home/paulo/Projetos/desafio/lovedcrm
  grep -r "lead.*response" components/ app/
  // Integrar template suggestions contextually
  ```
- **Files**: Existing lead response component (edit)
- **Validation**: Template suggestions appear during lead response typing
- **Rollback**: Remove template suggestion integration
- **Org-Safety**: Only show org-specific templates

#### **Slice 5: Integration Testing + Polish (2h)**

**Step 13: End-to-End Workflow Testing (1h)**

- **Objetivo**: Testar complete user workflow template creation ‚Üí usage
- **Comandos**:

  ```bash
  # Start full dev environment
  cd /home/paulo/Projetos/desafio/lovedcrm
  npm run dev  # Start both frontend + backend

  # Manual E2E testing workflow:
  # 1. Login as admin
  # 2. Create template
  # 3. Use template in lead response
  # 4. Verify variable substitution
  # 5. Check usage metrics
  ```

- **Files**: None (testing only)
- **Validation**: Complete workflow works end-to-end
- **Rollback**: N/A (testing phase)
- **Org-Safety**: Cross-org data isolation confirmed

**Step 14: UI Polish + Error Handling (0.5h)**

- **Objetivo**: Polish UI components + add comprehensive error handling
- **Comandos**:
  ```tsx
  // Add loading states, error boundaries, toast notifications
  cd /home/paulo/Projetos/desafio/lovedcrm
  # Polish template components with proper loading/error states
  ```
- **Files**: Template components (edit)
- **Validation**: Graceful error handling + user-friendly loading states
- **Rollback**: Revert UI polish changes
- **Org-Safety**: Error messages don't leak cross-org data

**Step 15: Code Quality + Documentation (0.5h)**

- **Objetivo**: Run linting, type checking + add basic component documentation
- **Comandos**:

  ```bash
  cd /home/paulo/Projetos/desafio/lovedcrm
  npm run quality  # ESLint + TypeScript check
  npm run quality:backend  # Python linting

  # Add JSDoc comments to key components
  ```

- **Files**: Component files (edit for documentation)
- **Validation**: `npm run quality` passes + components documented
- **Rollback**: Remove documentation comments
- **Org-Safety**: No sensitive data in documentation

---

## ‚úÖ **CRIT√âRIOS DE SUCESSO**

### **üéØ Definition of Done**

```yaml
Functional Criteria:
  ‚úÖ Admin pode criar templates com categorias (greeting, follow-up, objection, closing)
  ‚úÖ Templates suportam vari√°veis {{lead_name}}, {{company}}, {{value}}
  ‚úÖ Sistema salva template com organization_id filtering
  ‚úÖ Vendedor v√™ template suggestions durante lead response
  ‚úÖ Sistema faz variable auto-population com dados do lead
  ‚úÖ Sistema atualiza performance metrics (usage_count) do template

Technical Criteria:
  ‚úÖ Multi-tenancy: Organization isolation 100% funcional
  ‚úÖ Vertical Slice: End-to-end user workflow funcionando
  ‚úÖ Quality: TypeScript + ESLint + Python linting passing
  ‚úÖ Performance: Template queries < 500ms
  ‚úÖ Security: No vulnerabilidades introduzidas

User Value:
  ‚úÖ Immediate Value: Usu√°rio pode criar e usar templates imediatamente
  ‚úÖ Complete Workflow: Fluxo completo template creation ‚Üí usage ‚Üí metrics
  ‚úÖ Production Ready: Pode ir para produ√ß√£o com confian√ßa
```

### **üß™ Testing Strategy**

```yaml
Unit Tests:
  - Backend: TemplateService methods, variable substitution engine
  - Frontend: Template components, hooks, form validation

Integration Tests:
  - API endpoints com organization context
  - Frontend-backend template CRUD integration

E2E Tests:
  - Complete template workflow admin ‚Üí sales rep
  - Multi-tenant isolation validation
  - Cross-org data protection confirmation
```

---

## üö® **RISCOS E MITIGA√á√ÉO**

### **‚ö†Ô∏è Riscos Identificados**

```yaml
Technical Risks:
  Risk: Variable substitution pode quebrar se lead data missing
  Probability: Medium
  Impact: Medium
  Mitigation: Graceful fallback - manter {{variable}} se n√£o encontrar

Multi-tenancy Risks:
  Risk: Organization isolation breakdown
  Probability: Low
  Impact: Critical
  Mitigation: All queries incluem organization_id + extensive testing

Performance Risks:
  Risk: Template queries lentas com large volumes
  Probability: Low
  Impact: Medium
  Mitigation: Database indexes j√° implementados + pagination ready

UI/UX Risks:
  Risk: Mobile template creation difficulty
  Probability: Medium
  Impact: Low
  Mitigation: Mobile-first design + responsive components
```

### **üîÑ Rollback Strategy**

```yaml
Per Step Rollback:
  Database: N/A (table j√° exists)
  Backend: Remove model/service/router files + main.py import
  Frontend: Remove component/page files + route registration

Complete Rollback:
  Strategy: Remove all template-related files, keep database intact
  Time Required: 1 hour
  Data Safety: Database preservada, apenas remove code layer
```

---

## üíæ **DOCUMENTA√á√ÉO E TRACKING**

### **üìã Implementation Tracking**

```yaml
Checklist Format:
‚ñ° Step 1: Backend Model Implementation (2h estimado | __h real)
‚ñ° Step 2: Backend Service Layer (3h estimado | __h real)
‚ñ° Step 3: Backend API Router (1h estimado | __h real)
‚ñ° Step 4: FastAPI Main App Integration (0.5h estimado | __h real)
‚ñ° Step 5: Backend API Testing (1.5h estimado | __h real)
‚ñ° Step 6: Frontend API Service (1h estimado | __h real)
‚ñ° Step 7: Frontend Types & Schemas (1h estimado | __h real)
‚ñ° Step 8: Frontend Hooks Implementation (1h estimado | __h real)
‚ñ° Step 9: Template Management Page (2h estimado | __h real)
‚ñ° Step 10: Template CRUD Components (1.5h estimado | __h real)
‚ñ° Step 11: Variable Substitution UI (1h estimado | __h real)
‚ñ° Step 12: Template Suggestion Integration (0.5h estimado | __h real)
‚ñ° Step 13: End-to-End Workflow Testing (1h estimado | __h real)
‚ñ° Step 14: UI Polish + Error Handling (0.5h estimado | __h real)
‚ñ° Step 15: Code Quality + Documentation (0.5h estimado | __h real)

Progress Tracking:
  Start Date: [TBD]
  Target Completion: [TBD]
  Actual Completion: [TBD]
  Total Time: 18h estimated vs __h actual
```

### **üöÄ Next Actions**

```yaml
Immediate Next Steps:
  1. Validate plano com stakeholder/team
  2. Set up development environment (npm run dev)
  3. Begin com Step 1: Backend Model Implementation
  4. Update progress tracking conforme implementa√ß√£o progride

Dependencies:
  Blocks: Template A/B testing (Story 6.2)
  Blocked By: Nenhuma (foundation completa)
```

---

## üéØ **PLANO VALIDATION COMPLETA**

### **‚úÖ QUALITY GATES PASSED**

```yaml
‚úÖ SMART Criteria: Specific (templates CRUD), Measurable (usage metrics), Achievable (foundation exists), Relevant (sales productivity), Time-bound (3 days)
‚úÖ Vertical Slice: End-to-end value delivery garantido (create ‚Üí use ‚Üí track)
‚úÖ Multi-tenant Safe: Organization isolation preserved em todas layers
‚úÖ KISS Compliance: Simplicidade maximizada - extend foundation vs rebuild
‚úÖ Evidence-based: Baseado em an√°lise REAL do codebase + database schema
‚úÖ Refinement Integration: 99% certeza t√©cnica validada + decis√µes reutilizadas
‚úÖ Risk Management: Mitigation strategies definidas para todos riscos
‚úÖ Rollback Ready: Reversal plan para cada step sem data loss
```

### **üéâ READY FOR IMPLEMENTATION**

**Plano Status**: ‚úÖ APPROVED - Ready for exec-run
**Confidence Level**: 99% (evidence-based + refinement-validated)
**Timeline**: 18 hours estimated para complete implementation
**User Value**: 60% faster sales responses + messaging consistency

---

**Next Step**: Execute `exec-run "6.1"` para implementar este plano rigorosamente

---
