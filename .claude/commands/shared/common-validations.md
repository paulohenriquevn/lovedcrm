# common-validations.md

**üö® COMPONENTE COMPARTILHADO: Valida√ß√µes Comuns para Todos os Agentes Executivos**

**Este arquivo cont√©m valida√ß√µes reutiliz√°veis para eliminar 1200+ linhas duplicadas nos agentes executivos. Todos os agentes devem referenciar este arquivo em vez de duplicar valida√ß√µes.**

---

## üìã **LEITURA OBRIGAT√ìRIA ANTES DE QUALQUER EXECU√á√ÉO**

### **üö® COMPLIANCE E DOCUMENTA√á√ÉO FUNDAMENTAL (OBRIGAT√ìRIO)**

```yaml
Arquivos de Compliance (TODOS OS AGENTES EXECUTIVOS DEVEM LER):
  ‚úÖ CHANGELOG.md:
    - ANALISAR hist√≥rico completo de implementa√ß√µes do projeto
    - IDENTIFICAR padr√µes de desenvolvimento estabelecidos
    - VALIDAR contexto de mudan√ßas recentes

  ‚úÖ RULES.md:
    - CONFIRMAR compliance com regras cr√≠ticas do template
    - VALIDAR 95% confidence rule implementation
    - VERIFICAR multi-tenancy patterns obrigat√≥rios

  ‚úÖ migrations/README.md:
    - ENTENDER sistema de migra√ß√µes: ./migrate apply, seeds, etc.
    - VALIDAR schema consolidado v001 patterns
    - CONFIRMAR ambiente de seeds por environment
```

---

## üîç **AN√ÅLISE OBRIGAT√ìRIA DO CODEBASE ATUAL**

### **üìä DEPEND√äNCIAS E VERS√ïES (CRITICAL PATH)**

```yaml
Backend Dependencies (requirements.txt):
  ‚úÖ **DEVE**: Read requirements.txt
    - MAPEAR vers√µes REAIS: FastAPI, SQLAlchemy, etc.
    - IDENTIFICAR bibliotecas cr√≠ticas para multi-tenancy
    - VALIDAR compatibilidade de vers√µes

Frontend Dependencies (package.json):
  ‚úÖ **DEVE**: Read package.json
    - MAPEAR vers√µes REAIS: Next.js, React, shadcn/ui, etc.
    - IDENTIFICAR depend√™ncias para organization context
    - VALIDAR setup de development tools
```

### **üóÑÔ∏è DATABASE E SCHEMA ANALYSIS (CRITICAL PATH)**

```yaml
Schema State Validation:
  ‚úÖ **DEVE**: Bash "cd migrations && ./migrate status"
    - VERIFICAR vers√£o atual do schema vs target
    - IDENTIFICAR pending migrations que podem bloquear
    - VALIDAR database health antes de modifica√ß√µes

Schema Structure Understanding:
  ‚úÖ **DEVE**: Read migrations/001_consolidated_schema.sql (parcial)
    - MAPEAR tabelas principais: organizations, users, crm_leads
    - VALIDAR organization_id FK patterns em todas tabelas
    - CONFIRMAR multi-tenant isolation structure
```

### **üèóÔ∏è ARQUITETURA BACKEND MAPPING (CRITICAL PATH)**

```yaml
Backend Structure Analysis:
  ‚úÖ **DEVE**: LS api/models/
    - CATALOGAR todos models .py REAIS existentes
    - IDENTIFICAR patterns de organization_id implementation
    - MAPEAR relacionamentos cr√≠ticos para multi-tenancy

  ‚úÖ **DEVE**: LS api/services/
    - CATALOGAR services existentes REAIS
    - IDENTIFICAR patterns de business logic organization
    - VALIDAR separation of concerns implementation

  ‚úÖ **DEVE**: LS api/routers/
    - CATALOGAR endpoints existentes REAIS
    - IDENTIFICAR patterns de API organization
    - VALIDAR organization middleware application
```

### **üé® ARQUITETURA FRONTEND MAPPING (CRITICAL PATH)**

```yaml
Frontend Structure Analysis:
  ‚úÖ **DEVE**: LS components/ui/
    - CATALOGAR componentes shadcn/ui REAIS dispon√≠veis
    - IDENTIFICAR component patterns estabelecidos
    - VALIDAR design system compliance

  ‚úÖ **DEVE**: LS app/[locale]/admin/
    - MAPEAR estrutura de rotas admin REAIS
    - IDENTIFICAR organization-scoped routes patterns
    - VALIDAR multi-tenant frontend organization
```

### **üß™ TESTING INFRASTRUCTURE ANALYSIS**

```yaml
Testing Coverage Mapping:
  ‚úÖ **DEVE**: LS tests/e2e/api/
    - CATALOGAR testes e2e multi-tenant REAIS
    - IDENTIFICAR test patterns para organization isolation
    - VALIDAR coverage de security scenarios cr√≠ticos
```

---

## üö® **VALIDA√á√ïES OBRIGAT√ìRIAS DE ESTADO**

### **üî¥ ENVIRONMENT HEALTH CHECK (BLOQUEADORES CR√çTICOS)**

```yaml
Git Repository State:
  ‚úÖ **DEVE**: Bash "git status"
    - VERIFICAR working directory clean ou apenas arquivos n√£o-cr√≠ticos
    - IDENTIFICAR potential merge conflicts
    - VALIDAR branch state adequado para changes

TypeScript/Build Health:
  ‚úÖ **DEVE**: Bash "npm run typecheck"
    - VERIFICAR zero erros TypeScript antes de modifica√ß√µes
    - IDENTIFICAR type issues que podem bloquear implementa√ß√£o
    - VALIDAR build stability baseline

Testing Baseline:
  ‚úÖ **DEVE**: Execu√ß√£o seletiva baseada no tipo de mudan√ßa:
    - Para mudan√ßas backend: `python3 -m pytest tests/unit/ -q`
    - Para mudan√ßas frontend: `npm run test -- --run`
    - Para mudan√ßas multi-tenant: `python3 -m pytest tests/e2e/ -k "isolation"`
```

---

## ‚ö†Ô∏è **RED FLAGS CR√çTICOS - PARAR IMEDIATAMENTE**

### **üõë SITUA√á√ïES QUE EXIGEM PAUSA OBRIGAT√ìRIA**

#### **üî¥ RED FLAGS DE CODEBASE CORRUPTION**

```yaml
File System Issues: ‚ùå requirements.txt ou package.json corrompidos/ausentes
  ‚ùå migrations/001_consolidated_schema.sql ileg√≠vel/corrompido
  ‚ùå CHANGELOG.md ou RULES.md ausentes (compliance blocker)
  ‚ùå api/models/, api/services/, api/routers/ directories ausentes

Git Repository Issues: ‚ùå git status showing merge conflicts em arquivos cr√≠ticos
  ‚ùå Unstaged changes em arquivos core (models, services, migrations)
  ‚ùå Branch state inconsistente ou detached HEAD
```

#### **üî¥ RED FLAGS DE ENVIRONMENT BREAKDOWN**

```yaml
Dependency Issues: ‚ùå npm run typecheck failing com erros cr√≠ticos
  ‚ùå python3 -c "import api.main" failing (backend import errors)
  ‚ùå ./migrate status failing ou showing critical errors
  ‚ùå Database connection errors ou schema version conflicts

Service Issues: ‚ùå Backend/Frontend services n√£o inicializando
  ‚ùå Critical tests failing no baseline (organization isolation tests)
  ‚ùå Build processes failing with blocking errors
```

#### **üî¥ RED FLAGS DE MULTI-TENANCY VIOLATIONS**

```yaml
Organization Isolation Risks: ‚ùå Models sem organization_id FK identification
  ‚ùå API endpoints sem organization middleware patterns
  ‚ùå Frontend sem useOrgContext/BaseService patterns
  ‚ùå Database queries sem organization filtering evidence
  ‚ùå Cross-org data access patterns identified em existing code
```

#### **üî¥ RED FLAGS DE COMPLIANCE VIOLATIONS**

```yaml
Template Compliance Issues: ‚ùå RULES.md violations em existing codebase (95% confidence broken)
  ‚ùå Multi-tenancy patterns n√£o implementados consistently
  ‚ùå Security vulnerabilities identificadas em analysis
  ‚ùå Performance degradation evidence em existing implementation
```

### **‚ö° A√á√ÉO IMEDIATA QUANDO RED FLAG DETECTADO**

```
üö® RED FLAG CR√çTICO DETECTADO: [Tipo espec√≠fico identificado]

‚ö†Ô∏è EXECU√á√ÉO BLOQUEADA: [Descri√ß√£o espec√≠fica do problema encontrado]

üõë ENVIRONMENT INSEGURO - PAUSANDO IMEDIATAMENTE

üìã PROBLEMAS CR√çTICOS IDENTIFICADOS:
- [Problema espec√≠fico 1]: [Impacto detalhado]
- [Problema espec√≠fico 2]: [Consequ√™ncia identificada]
- [Problema espec√≠fico N]: [Risco catalogado]

üîß RESOLU√á√ÉO OBRIGAT√ìRIA ANTES DE CONTINUAR:
- [A√ß√£o espec√≠fica 1 para resolver problema]
- [A√ß√£o espec√≠fica 2 para validar corre√ß√£o]
- [Valida√ß√£o final necess√°ria para confirmar seguran√ßa]

‚è≥ AGUARDANDO RESOLU√á√ÉO COMPLETA DOS RED FLAGS...

üìû ESCALAR PARA: Review manual se red flags persistirem ap√≥s corre√ß√£o
```

---

## ‚úÖ **VALIDATION CHECKPOINTS PADRONIZADOS**

### **üìã CHECKLIST DE VALIDA√á√ÉO PRE-EXECU√á√ÉO**

```yaml
Compliance Validation (OBRIGAT√ìRIO): ‚ñ° CHANGELOG.md lido e contexto compreendido
  ‚ñ° RULES.md compliance validado (95% confidence + multi-tenancy)
  ‚ñ° migrations/README.md patterns compreendidos
  ‚ñ° tests/e2e/api/ coverage mapeado para organization isolation

Codebase Analysis (OBRIGAT√ìRIO): ‚ñ° requirements.txt + package.json versions mapeadas
  ‚ñ° ./migrate status executado e schema state validado
  ‚ñ° api/models/ + api/services/ + api/routers/ catalogados
  ‚ñ° components/ui/ + app/[locale]/admin/ mapeados

Environment Health (OBRIGAT√ìRIO): ‚ñ° git status clean ou apenas non-critical files modified
  ‚ñ° npm run typecheck passing (zero TypeScript errors)
  ‚ñ° Baseline tests relevant para mudan√ßa passing
  ‚ñ° Database connectivity e schema consistency confirmed

Multi-Tenancy Validation (CRITICAL): ‚ñ° Organization isolation patterns identificados e validados
  ‚ñ° X-Org-Id middleware patterns confirmed em existing code
  ‚ñ° organization_id FK patterns validated em all relevant models
  ‚ñ° useOrgContext + BaseService patterns confirmed em frontend
```

---

## üéØ **SUCCESS CRITERIA TEMPLATES**

### **üìä VALIDATION EVIDENCE REQUIREMENTS**

```yaml
Evidence-Based Validation (TODOS OS AGENTES):

  File Reading Evidence:
    ‚úÖ CHANGELOG.md: [COLAR 3-5 linhas das implementa√ß√µes recentes]
    ‚úÖ requirements.txt: [COLAR principais dependencies com vers√µes]
    ‚úÖ package.json: [COLAR principais dependencies frontend]
    ‚úÖ ./migrate status: [COLAR output do comando]

  Architecture Mapping Evidence:
    ‚úÖ api/models/: [LISTAR arquivos .py encontrados]
    ‚úÖ api/services/: [LISTAR services implementados]
    ‚úÖ components/ui/: [LISTAR componentes shadcn/ui dispon√≠veis]
    ‚úÖ app/[locale]/admin/: [LISTAR estrutura de rotas admin]

  Health Check Evidence:
    ‚úÖ git status: [COLAR status output]
    ‚úÖ npm run typecheck: [CONFIRMAR zero errors ou COLAR errors]
    ‚úÖ Relevant tests: [COLAR test results baseados no tipo de mudan√ßa]

‚ùå FALHA CR√çTICA se qualquer valida√ß√£o n√£o tiver EVID√äNCIA REAL de execu√ß√£o
```

---

## üîß **ROLLBACK E RECOVERY PROCEDURES**

### **üö® EMERGENCY ROLLBACK COMMANDS**

```bash
# Git-based rollback (para file changes)
git checkout .                    # Discard unstaged changes
git reset --hard HEAD~1          # Rollback last commit (if committed)

# Database rollback (para schema changes)
cd migrations && ./migrate rollback 1  # Rollback 1 migration

# Service recovery (para service corruption)
pkill -f "node.*next" && pkill -f "uvicorn"  # Kill corrupted services
npm run dev                       # Restart development environment

# Dependency recovery (para dependency issues)
rm -rf node_modules package-lock.json && npm install  # Frontend deps
pip install --force-reinstall -r requirements.txt    # Backend deps
```

### **üìã ROLLBACK VALIDATION CHECKLIST**

```yaml
Post-Rollback Validation: ‚ñ° git status showing clean working directory
  ‚ñ° ./migrate status showing expected schema version
  ‚ñ° npm run typecheck passing ap√≥s rollback
  ‚ñ° Baseline tests passing ap√≥s recovery
  ‚ñ° Services inicializando normally ap√≥s restart
  ‚ñ° Database connectivity restored
  ‚ñ° Multi-tenancy isolation maintained
```

---

## üìö **INTEGRATION PATTERNS**

### **üîó COMO USAR EM AGENTES EXECUTIVOS**

```markdown
## [SE√á√ÉO DO AGENTE]

### **üìã VALIDA√á√ïES PR√â-REQUISITOS**

**üîó REFER√äNCIA**: `@shared/common-validations.md#leitura-obrigat√≥ria`

- ‚úÖ **Compliance Check**: CHANGELOG.md + RULES.md + migrations/README.md
- ‚úÖ **Codebase Analysis**: Dependencies + Schema + Architecture mapping
- ‚úÖ **Environment Health**: Git + TypeScript + Database + Testing baseline
- ‚úÖ **Multi-Tenancy**: Organization patterns validation

### **üö® VALIDA√á√ÉO CR√çTICA**

**üîó REFER√äNCIA**: `@shared/common-validations.md#red-flags-cr√≠ticos`

‚ùå **PARAR IMEDIATAMENTE SE**: Qualquer red flag identificado
‚úÖ **PROSSEGUIR APENAS SE**: Todos checkpoints validados com evid√™ncias

### **üìä EVIDENCE REQUIREMENTS**

**üîó REFER√äNCIA**: `@shared/common-validations.md#validation-evidence-requirements`

[Agente deve colar evid√™ncias REAIS conforme template]
```

---

## üéØ **BENEFITS OF SHARED VALIDATIONS**

### **üìâ ELIMINA√á√ÉO DE DUPLICA√á√ÉO**

```yaml
Antes (Duplica√ß√£o Massiva):
  - exec-refine.md: 300+ linhas de valida√ß√µes
  - exec-story.md: 400+ linhas de valida√ß√µes
  - exec-run.md: 350+ linhas de valida√ß√µes
  - exec-review.md: 250+ linhas de valida√ß√µes
  Total: 1200+ linhas DUPLICADAS

Depois (Refer√™ncia Centralizada):
  - shared/common-validations.md: 350 linhas CENTRALIZADAS
  - Cada agente: 10-15 linhas de refer√™ncia
  Total: 400 linhas (‚Üì67% redu√ß√£o)
```

### **üîß MANUTEN√á√ÉO SIMPLIFICADA**

```yaml
Update Process:
  Antes: Mudan√ßa em valida√ß√£o = update em 4-6 arquivos
  Depois: Mudan√ßa em valida√ß√£o = update em 1 arquivo apenas

Consistency:
  Antes: Risk de inconsist√™ncias entre agentes
  Depois: Guaranteed consistency via shared reference

Testing:
  Antes: Validate consistency across multiple files
  Depois: Single source of truth testing
```

### **‚ö° PERFORMANCE MELHORADA**

```yaml
Execution Time:
  Antes: 10-15min de valida√ß√µes redundantes por agente
  Depois: 3-5min de valida√ß√µes otimizadas e centralizadas

Cognitive Load:
  Antes: Developer precisa entender valida√ß√µes em cada agente
  Depois: Single comprehensive validation reference

Error Reduction:
  Antes: Multiple places para validation errors occur
  Depois: Centralized validation = centralized error handling
```

---

## üö® **USAGE REQUIREMENTS**

### **üìã OBRIGATORIEDADE PARA AGENTES EXECUTIVOS**

```yaml
TODOS os agentes executivos DEVEM: ‚úÖ Referenciar @shared/common-validations.md
  ‚ùå NUNCA duplicar valida√ß√µes que existem neste arquivo
  ‚úÖ Seguir templates de evid√™ncia definidos aqui
  ‚úÖ Usar red flags e rollback procedures padronizados

Agentes Afetados (OBRIGAT√ìRIO):
  - exec-refine.md
  - exec-story.md
  - exec-run.md
  - exec-review.md
  - exec-context.md
  - exec-bug.md (quando criado)
```

### **üîß CUSTOMIZA√á√ÉO PERMITIDA**

```yaml
Agentes PODEM adicionar: ‚úÖ Valida√ß√µes espec√≠ficas √∫nicas para sua fun√ß√£o
  ‚úÖ Checkpoints adicionais espec√≠ficos do workflow
  ‚úÖ Success criteria espec√≠ficos do output esperado

Agentes N√ÉO PODEM: ‚ùå Duplicar valida√ß√µes que existem neste shared file
  ‚ùå Modificar red flags ou rollback procedures padr√£o
  ‚ùå Ignorar compliance checks fundamentais
```

---

**üéâ SHARED VALIDATIONS IMPLEMENTADO**

Este arquivo elimina **1200+ linhas duplicadas** e centraliza **valida√ß√µes cr√≠ticas** para manuten√ß√£o simplificada e consistency garantida across all executive agents.

**Next Step**: Update agents to reference `@shared/common-validations.md` instead of duplicating validation content.
